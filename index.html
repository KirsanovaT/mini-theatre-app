<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Театральный планировщик</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Твой стиль без изменений */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background 0.3s, color 0.3s;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        button:hover {
            background: var(--tg-theme-button-color-hover, var(--tg-theme-button-color));
            transform: scale(1.02);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            box-sizing: border-box;
            font-size: 16px;
            transition: border 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--tg-theme-button-color);
            outline: none;
        }
        .event, .task {
            background: var(--tg-theme-secondary-bg-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hidden {
            display: none;
        }
        .error {
            color: var(--tg-theme-destructive-text-color);
            text-align: center;
            margin-top: 5px;
        }
        .participant {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 5px;
            border-radius: 8px;
            background: var(--tg-theme-bg-color);
        }
        .participant input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        .stats-table, .repertoire-table, .tasks-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-table th, .stats-table td, .repertoire-table th, .repertoire-table td, .tasks-table th, .tasks-table td {
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color);
            text-align: left;
            font-size: 0.9em;
        }
        th {
            background: var(--tg-theme-secondary-bg-color);
            font-weight: bold;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .nav-buttons button {
            width: 48%;
        }
        .task-actions {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .task-actions button {
            width: 45%;
            padding: 8px;
            font-size: 0.9em;
            border-radius: 6px;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status.planned {
            background: #fff3cd;
            color: #856404;
        }
        .status.confirmed {
            background: #d4edda;
            color: #155724;
        }
        .status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        #user-info {
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            color: var(--tg-theme-hint-color);
        }
        #main-menu button, #admin-panel button {
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Театральный планировщик</h1>
        <div id="user-info"></div>
        <!-- Форма подтверждения -->
        <div id="confirm-section">
            <h2>Подтверждение аккаунта</h2>
            <p>Введите ваше ФИО для доступа к приложению:</p>
            <input type="text" id="fio-input" placeholder="Фамилия Имя Отчество">
            <select id="role-request">
                <option value="actor">Актер</option>
                <option value="workshop_worker">Работник цеха</option>
                <option value="workshop_head">Заведующий цехом</option>
            </select>
            <select id="workshop-request" class="hidden">
                <option value="costume">Костюмерный</option>
                <option value="props">Бутафорский</option>
                <option value="lighting">Осветительный</option>
                <option value="sound">Звуковой</option>
                <option value="stage">Монтировочный</option>
            </select>
            <button onclick="sendForConfirmation()"><i class="fas fa-check"></i> Отправить на подтверждение</button>
            <p class="error hidden" id="error-msg">Пожалуйста, заполните ФИО и роль</p>
            <p>Данные отправятся администратору. После одобрения вы получите доступ.</p>
        </div>
        <!-- Главное меню -->
        <div id="main-menu" class="hidden">
            <button onclick="showSchedule()"><i class="fas fa-calendar-alt"></i> Расписание</button>
            <button onclick="startCreateEvent()"><i class="fas fa-plus"></i> Создать событие</button>
            <button onclick="startWorkshopTasks()"><i class="fas fa-tasks"></i> Задачи цехам</button>
            <button onclick="showRepertoire()"><i class="fas fa-book"></i> Репертуар на месяц</button>
            <button onclick="showStats()"><i class="fas fa-chart-bar"></i> Статистика</button>
        </div>
        <!-- Админ-панель (для troupe_head и workshop_head) -->
        <div id="admin-panel" class="hidden">
            <h2>Админ-панель</h2>
            <button onclick="showPendingConfirmations()"><i class="fas fa-user-check"></i> Неподтверждённые пользователи</button>
            <button onclick="manageUsers()"><i class="fas fa-users-cog"></i> Управление пользователями</button>
            <button onclick="manageEvents()"><i class="fas fa-calendar-cog"></i> Управление событиями</button>
            <button onclick="manageTasks()"><i class="fas fa-tasks-alt"></i> Управление задачами</button>
        </div>
        <!-- Неподтверждённые пользователи -->
        <div id="pending-confirmations" class="hidden">
            <h2>Неподтверждённые пользователи</h2>
            <div id="pending-list"></div>
            <div class="nav-buttons">
                <button onclick="backToAdminPanel()"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
        </div>
        <!-- Управление пользователями -->
        <div id="manage-users" class="hidden">
            <h2>Управление пользователями</h2>
            <div id="users-list"></div>
            <div class="nav-buttons">
                <button onclick="backToAdminPanel()"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
        </div>
        <!-- Управление событиями -->
        <div id="manage-events" class="hidden">
            <h2>Управление событиями</h2>
            <div id="events-manage-list"></div>
            <div class="nav-buttons">
                <button onclick="backToAdminPanel()"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
        </div>
        <!-- Управление задачами -->
        <div id="manage-tasks" class="hidden">
            <h2>Управление задачами</h2>
            <div id="tasks-manage-list"></div>
            <div class="nav-buttons">
                <button onclick="backToAdminPanel()"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
        </div>
        <!-- Расписание -->
        <div id="schedule" class="hidden">
            <h2>Расписание</h2>
            <select id="period-select" onchange="loadSchedule(this.value)">
                <option value="today">Сегодня</option>
                <option value="tomorrow">Завтра</option>
                <option value="week">Неделя</option>
                <option value="month">Месяц</option>
            </select>
            <div id="events-list"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
        </div>
        <!-- Создание/редактирование события -->
        <div id="create-event" class="hidden">
            <h2 id="event-form-title">Создать событие</h2>
            <input type="text" id="event-title" placeholder="Название события">
            <input type="text" id="event-datetime" placeholder="Дата и время начала">
            <input type="text" id="event-end-datetime" placeholder="Дата и время окончания">
            <select id="event-type">
                <option value="rehearsal">Репетиция</option>
                <option value="performance">Спектакль</option>
                <option value="meeting">Собрание</option>
                <option value="other">Другое</option>
            </select>
            <textarea id="event-description" placeholder="Описание (необязательно)"></textarea>
            <div id="participants-list"></div>
            <div class="nav-buttons">
                <button onclick="saveEvent()"><i class="fas fa-save"></i> Сохранить</button>
                <button onclick="cancelEventEdit()"><i class="fas fa-times"></i> Отмена</button>
            </div>
        </div>
        <!-- Задачи цехам -->
        <div id="workshop-tasks" class="hidden">
            <h2>Задачи цехам</h2>
            <button onclick="startCreateTask()"><i class="fas fa-plus"></i> Создать новую задачу</button>
            <div id="tasks-list"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
        </div>
        <!-- Создание задачи -->
        <div id="create-task" class="hidden">
            <h2>Новая задача для цеха</h2>
            <input type="text" id="task-title" placeholder="Название задачи">
            <select id="task-department">
                <option value="costume">Костюмерный</option>
                <option value="props">Бутафорский</option>
                <option value="lighting">Осветительный</option>
                <option value="sound">Звуковой</option>
                <option value="stage">Монтировочный</option>
            </select>
            <input type="text" id="task-deadline" placeholder="Срок выполнения">
            <textarea id="task-description" placeholder="Подробное описание"></textarea>
            <div class="nav-buttons">
                <button onclick="saveTask()"><i class="fas fa-save"></i> Сохранить</button>
                <button onclick="backToWorkshopTasks()"><i class="fas fa-times"></i> Отмена</button>
            </div>
        </div>
        <!-- Репертуар на месяц -->
        <div id="repertoire" class="hidden">
            <h2>Репертуар на месяц</h2>
            <div id="repertoire-table-container"></div>
            <button onclick="exportRepertoire()"><i class="fas fa-file-export"></i> Экспорт в Excel</button>
            <div class="nav-buttons">
                <button onclick="backToMenu()"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
        </div>
        <!-- Статистика -->
        <div id="stats" class="hidden">
            <h2>Статистика</h2>
            <div id="stats-content"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
        </div>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        const user = tg.initDataUnsafe.user || { id: 123456, username: 'testuser' };
        const initData = tg.initData; // Для аутентификации
        const API_URL = 'http://localhost:3000/api'; // Замени на URL backend
        let userFIO = '';
        let userRole = 'pending';
        let userWorkshop = null;
        let isConfirmed = false;
        let events = [];
        let tasks = [];
        let participants = [];
        let pendingUsers = [];
        let currentEditEventId = null;
        // Хелпер для fetch с аутентификацией
        async function apiFetch(endpoint, method = 'GET', body = null) {
            const headers = { 'Authorization': initData };
            if (body) headers['Content-Type'] = 'application/json';
            const response = await fetch(`${API_URL}${endpoint}`, {
                method,
                headers,
                body: body ? JSON.stringify(body) : null
            });
            return response;
        }
        // Инициализация
        async function init() {
            document.getElementById('role-request').addEventListener('change', function() {
                const workshopSelect = document.getElementById('workshop-request');
                if (this.value.includes('workshop')) {
                    workshopSelect.classList.remove('hidden');
                } else {
                    workshopSelect.classList.add('hidden');
                }
            });
            await loadUser();
            if (isConfirmed && userFIO) {
                hideConfirmShowMenu();
                updateMenuByRole();
            } else {
                document.getElementById('confirm-section').classList.remove('hidden');
            }
            await loadParticipants();
        }
        async function loadUser() {
            try {
                const response = await apiFetch('/user');
                const userData = await response.json();
                if (userData) {
                    userFIO = userData.fio;
                    userRole = userData.role;
                    userWorkshop = userData.workshop;
                    isConfirmed = userData.confirmed;
                }
            } catch (e) {
                console.error(e);
            }
        }
        function hideConfirmShowMenu() {
            document.getElementById('confirm-section').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('user-info').textContent = `Добро пожаловать, ${userFIO}! Роль: ${getRoleText(userRole)}${userWorkshop ? ' (' + getDepartmentText(userWorkshop) + ')' : ''}`;
        }
        function updateMenuByRole() {
            if (['troupe_head', 'workshop_head'].includes(userRole)) {
                document.getElementById('admin-panel').classList.remove('hidden');
            }
            if (!['actor', 'troupe_head'].includes(userRole)) {
                document.querySelector('button[onclick="startCreateEvent()"]').classList.add('hidden');
            }
            if (userRole === 'actor') {
                document.querySelector('button[onclick="startWorkshopTasks()"]').classList.add('hidden');
            }
            if (userRole === 'workshop_worker') {
                document.querySelector('button[onclick="showSchedule()"]').textContent = 'Моё расписание';
                document.querySelector('button[onclick="startCreateEvent()"]').classList.add('hidden');
            } else {
                document.querySelector('button[onclick="showSchedule()"]').textContent = 'Расписание театра';
            }
        }
        // Подтверждение с ролью
        async function sendForConfirmation() {
            const fio = document.getElementById('fio-input').value.trim();
            const requestedRole = document.getElementById('role-request').value;
            const requestedWorkshop = requestedRole.includes('workshop') ? document.getElementById('workshop-request').value : null;
            if (!fio || (requestedRole.includes('workshop') && !requestedWorkshop)) {
                document.getElementById('error-msg').classList.remove('hidden');
                return;
            }
            try {
                const response = await apiFetch('/request_confirmation', 'POST', {
                    fio,
                    requested_role: requestedRole,
                    requested_workshop: requestedWorkshop,
                    username: user.username || ''
                });
                if (response.ok) {
                    tg.showAlert('Заявка отправлена. Ждите подтверждения.');
                } else {
                    tg.showAlert('Ошибка отправки');
                }
            } catch (e) {
                tg.showAlert('Ошибка отправки: ' + e.message);
            }
        }
        // Проверка подтверждения
        function requireConfirmation() {
            if (!isConfirmed) {
                tg.showAlert('Сначала подтвердите аккаунт');
                return false;
            }
            return true;
        }
        // Навигация
        function backToMenu() {
            hideAllSections();
            document.getElementById('main-menu').classList.remove('hidden');
            if (['troupe_head', 'workshop_head'].includes(userRole)) {
                document.getElementById('admin-panel').classList.remove('hidden');
            }
            tg.BackButton.hide();
        }
        function backToWorkshopTasks() {
            document.getElementById('create-task').classList.add('hidden');
            document.getElementById('workshop-tasks').classList.remove('hidden');
        }
        function backToAdminPanel() {
            hideAllSections();
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
        }
        function hideAllSections() {
            document.querySelectorAll('#main-menu, #admin-panel, #schedule, #create-event, #workshop-tasks, #create-task, #repertoire, #stats, #pending-confirmations, #manage-users, #manage-events, #manage-tasks')
                .forEach(el => el.classList.add('hidden'));
        }
        function cancelEventEdit() {
            if (currentEditEventId) {
                document.getElementById('create-event').classList.add('hidden');
                document.getElementById('manage-events').classList.remove('hidden');
            } else {
                backToMenu();
            }
        }
        // ===== РАСПИСАНИЕ =====
        function showSchedule() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('schedule').classList.remove('hidden');
            loadSchedule('today');
            tg.BackButton.show().onClick(backToMenu);
        }
        async function loadSchedule(period) {
            await loadEvents();
            const list = document.getElementById('events-list');
            list.innerHTML = '';
            const now = new Date();
            let filtered = events.filter(e => {
                const eventDate = new Date(e.datetime);
                let matchesPeriod = false;
                switch (period) {
                    case 'today':
                        matchesPeriod = isSameDay(eventDate, now);
                        break;
                    case 'tomorrow':
                        const tomorrow = new Date(now);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        matchesPeriod = isSameDay(eventDate, tomorrow);
                        break;
                    case 'week':
                        const weekEnd = new Date(now);
                        weekEnd.setDate(weekEnd.getDate() + 7);
                        matchesPeriod = eventDate >= now && eventDate <= weekEnd;
                        break;
                    case 'month':
                        matchesPeriod = eventDate.getMonth() === now.getMonth() && eventDate.getFullYear() === now.getFullYear();
                        break;
                    default:
                        matchesPeriod = true;
                }
                return matchesPeriod;
            });
            if (['actor', 'workshop_worker'].includes(userRole)) {
                filtered = filtered.filter(e => e.participants.some(p => p.id === user.id));
            }
            if (filtered.length === 0) {
                list.innerHTML = '<p>На выбранный период событий нет.</p>';
                return;
            }
            filtered.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            filtered.forEach(e => {
                const div = document.createElement('div');
                div.className = 'event';
                div.innerHTML = `
                    <strong>${e.title}</strong><br>
                    Начало: ${formatDate(e.datetime)}<br>
                    Конец: ${formatDate(e.end_datetime)}<br>
                    Тип: ${getTypeText(e.type)}<br>
                    <span class="status ${e.status || 'planned'}">${getStatusText(e.status || 'planned')}</span>
                `;
                list.appendChild(div);
            });
        }
        // ===== СОЗДАНИЕ/РЕДАКТИРОВАНИЕ СОБЫТИЯ =====
        function startCreateEvent() {
            if (!requireConfirmation() || !['actor', 'troupe_head'].includes(userRole)) {
                tg.showAlert('У вас нет прав на создание событий');
                return;
            }
            hideAllSections();
            document.getElementById('create-event').classList.remove('hidden');
            document.getElementById('event-form-title').textContent = 'Создать событие';
            currentEditEventId = null;
            clearEventForm();
            renderParticipantsList();
            initFlatpickr(true);
            tg.BackButton.show().onClick(cancelEventEdit);
        }
        function initFlatpickr(isNew = true) {
            flatpickr("#event-datetime", {
                enableTime: true,
                dateFormat: "d.m.Y H:i",
                locale: "ru",
                minDate: isNew ? "today" : null
            });
            flatpickr("#event-end-datetime", {
                enableTime: true,
                dateFormat: "d.m.Y H:i",
                locale: "ru",
                minDate: isNew ? "today" : null
            });
        }
        function clearEventForm() {
            document.getElementById('event-title').value = '';
            document.getElementById('event-datetime').value = '';
            document.getElementById('event-end-datetime').value = '';
            document.getElementById('event-type').value = 'rehearsal';
            document.getElementById('event-description').value = '';
            document.querySelectorAll('#participants-list input[type="checkbox"]').forEach(cb => cb.checked = false);
        }
        function renderParticipantsList(eventParticipants = []) {
            const container = document.getElementById('participants-list');
            container.innerHTML = '<h3>Участники:</h3>';
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.innerHTML = `
                    <input type="checkbox" id="part-${p.tg_id}" value="${p.tg_id}" ${eventParticipants.some(ep => ep.id === p.tg_id) ? 'checked' : ''}>
                    <label for="part-${p.tg_id}">${p.fio} (${getRoleText(p.role)})</label>
                `;
                container.appendChild(div);
            });
        }
        async function saveEvent() {
            const title = document.getElementById('event-title').value.trim();
            const datetime = document.getElementById('event-datetime').value;
            const end_datetime = document.getElementById('event-end-datetime').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value.trim();
            if (!title || !datetime || !end_datetime) {
                tg.showAlert('Заполните название, дату/время начала и окончания');
                return;
            }
            const startDate = parseDate(datetime);
            const endDate = parseDate(end_datetime);
            if (startDate >= endDate) {
                tg.showAlert('Время окончания должно быть после начала');
                return;
            }
            const selectedParticipants = Array.from(document.querySelectorAll('#participants-list input:checked'))
                .map(cb => ({
                    id: parseInt(cb.value),
                    fio: cb.nextElementSibling.textContent.split(' (')[0]
                }));
            const eventData = {
                title,
                datetime: formatToISO(datetime),
                end_datetime: formatToISO(end_datetime),
                type,
                description,
                participants: selectedParticipants,
                status: 'planned',
                created_by: user.id
            };
            try {
                const endpoint = currentEditEventId ? `/events/${currentEditEventId}` : '/events';
                const method = currentEditEventId ? 'PUT' : 'POST';
                const response = await apiFetch(endpoint, method, eventData);
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Неизвестная ошибка');
                }
                tg.showAlert(currentEditEventId ? 'Событие обновлено' : 'Событие создано');
                currentEditEventId ? manageEvents() : backToMenu();
            } catch (e) {
                tg.showAlert('Ошибка сохранения: ' + e.message);
            }
        }
        // ===== ЗАДАЧИ ЦЕХАМ =====
        // (без изменений, так как ошибка, вероятно, в событиях)
        function startWorkshopTasks() {
            if (!requireConfirmation() || !['workshop_head', 'workshop_worker', 'troupe_head'].includes(userRole)) return;
            hideAllSections();
            document.getElementById('workshop-tasks').classList.remove('hidden');
            loadTasks();
            tg.BackButton.show().onClick(backToMenu);
        }
        async function loadTasks() {
            await loadTasksData();
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            let filteredTasks = tasks;
            if (['workshop_head', 'workshop_worker'].includes(userRole)) {
                filteredTasks = tasks.filter(t => t.department === userWorkshop);
            }
            if (filteredTasks.length === 0) {
                list.innerHTML = '<p>Задач пока нет</p>';
                return;
            }
            filteredTasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
            filteredTasks.forEach(t => {
                const div = document.createElement('div');
                div.className = 'task';
                div.innerHTML = `
                    <strong>${t.title}</strong> (${getDepartmentText(t.department)})<br>
                    Срок: ${t.deadline}<br>
                    <span class="status ${t.status}">${getStatusText(t.status)}</span>
                `;
                if (['workshop_head', 'troupe_head'].includes(userRole)) {
                    div.innerHTML += `
                        <div class="task-actions">
                            <button onclick="completeTask(${t.id})">Выполнено</button>
                            <button onclick="cancelTask(${t.id})">Отменить</button>
                        </div>
                    `;
                } else if (userRole === 'workshop_worker' && t.status === 'planned') {
                    div.innerHTML += `
                        <div class="task-actions">
                            <button onclick="completeTask(${t.id})">Выполнено</button>
                        </div>
                    `;
                }
                list.appendChild(div);
            });
        }
        function startCreateTask() {
            if (!['workshop_head', 'troupe_head'].includes(userRole)) {
                tg.showAlert('У вас нет прав на создание задач');
                return;
            }
            hideAllSections();
            document.getElementById('create-task').classList.remove('hidden');
            flatpickr("#task-deadline", {
                dateFormat: "d.m.Y",
                locale: "ru",
                minDate: "today"
            });
            if (userRole === 'workshop_head') {
                document.getElementById('task-department').value = userWorkshop;
                document.getElementById('task-department').disabled = true;
            }
            tg.BackButton.show().onClick(backToWorkshopTasks);
        }
        async function saveTask() {
            const title = document.getElementById('task-title').value.trim();
            let department = document.getElementById('task-department').value;
            const deadline = document.getElementById('task-deadline').value;
            const description = document.getElementById('task-description').value.trim();
            if (!title || !deadline) {
                tg.showAlert('Заполните название и срок');
                return;
            }
            if (userRole === 'workshop_head') {
                department = userWorkshop;
            }
            const newTask = {
                title,
                department,
                deadline,
                description,
                status: 'planned',
                created_by: userFIO
            };
            try {
                const response = await apiFetch('/tasks', 'POST', newTask);
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Неизвестная ошибка');
                }
                tg.showAlert('Задача создана');
                startWorkshopTasks();
            } catch (e) {
                tg.showAlert('Ошибка сохранения: ' + e.message);
            }
        }
        async function completeTask(id) {
            try {
                const response = await apiFetch(`/tasks/${id}`, 'PUT', { status: 'confirmed' });
                if (response.ok) loadTasks();
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        async function cancelTask(id) {
            try {
                const response = await apiFetch(`/tasks/${id}`, 'PUT', { status: 'cancelled' });
                if (response.ok) loadTasks();
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        // ===== РЕПЕРТУАР =====
        function showRepertoire() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('repertoire').classList.remove('hidden');
            renderRepertoireTable();
            tg.BackButton.show().onClick(backToMenu);
        }
        async function renderRepertoireTable() {
            await loadEvents();
            const container = document.getElementById('repertoire-table-container');
            const now = new Date();
            const performances = events.filter(e => e.type === 'performance' && new Date(e.datetime).getMonth() === now.getMonth());
            if (performances.length === 0) {
                container.innerHTML = '<p>Спектаклей в репертуаре нет</p>';
                return;
            }
            let table = '<table class="repertoire-table"><thead><tr><th>Дата</th><th>Спектакль</th><th>Статус</th></tr></thead><tbody>';
            performances.forEach(p => {
                table += `<tr><td>${formatDate(p.datetime)}</td><td>${p.title}</td><td><span class="status ${p.status || 'planned'}">${getStatusText(p.status || 'planned')}</span></td></tr>`;
            });
            table += '</tbody></table>';
            container.innerHTML = table;
        }
        async function exportRepertoire() {
            await loadEvents();
            const wb = XLSX.utils.book_new();
            const now = new Date();
            const data = events.filter(e => e.type === 'performance' && new Date(e.datetime).getMonth() === now.getMonth()).map(e => ({
                Дата: formatDate(e.datetime),
                Спектакль: e.title,
                Статус: getStatusText(e.status || 'planned')
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Репертуар");
            XLSX.writeFile(wb, "repertoire.xlsx");
        }
        // ===== СТАТИСТИКА =====
        function showStats() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('stats').classList.remove('hidden');
            renderStats();
            tg.BackButton.show().onClick(backToMenu);
        }
        async function renderStats() {
            await loadEvents();
            await loadTasksData();
            const content = document.getElementById('stats-content');
            let totalEvents = events.length;
            let rehearsals = events.filter(e => e.type === 'rehearsal').length;
            let performances = events.filter(e => e.type === 'performance').length;
            let myEvents = events.filter(e => e.participants.some(p => p.id === user.id)).length;
            let totalTasks = tasks.length;
            if (['actor', 'workshop_worker'].includes(userRole)) {
                totalEvents = myEvents;
                rehearsals = events.filter(e => e.type === 'rehearsal' && e.participants.some(p => p.id === user.id)).length;
                performances = events.filter(e => e.type === 'performance' && e.participants.some(p => p.id === user.id)).length;
                totalTasks = tasks.filter(t => t.department === userWorkshop).length;
            } else if (userRole === 'workshop_head') {
                totalTasks = tasks.filter(t => t.department === userWorkshop).length;
            }
            content.innerHTML = `
                <p>Всего событий: ${totalEvents}</p>
                <p>Репетиций: ${rehearsals}</p>
                <p>Спектаклей: ${performances}</p>
                <p>Ваши события: ${myEvents}</p>
                <p>Задач цехам: ${totalTasks}</p>
            `;
        }
        // ===== АДМИН-ПАНЕЛЬ =====
        function showPendingConfirmations() {
            if (!['troupe_head', 'workshop_head'].includes(userRole)) return;
            hideAllSections();
            document.getElementById('pending-confirmations').classList.remove('hidden');
            loadPendingList();
            tg.BackButton.show().onClick(backToAdminPanel);
        }
        async function loadPendingList() {
            await loadPendingUsers();
            const list = document.getElementById('pending-list');
            list.innerHTML = '';
            let filteredPending = pendingUsers;
            if (userRole === 'workshop_head') {
                filteredPending = pendingUsers.filter(p => p.requested_role.includes('workshop') && p.requested_workshop === userWorkshop);
            }
            filteredPending.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.innerHTML = `
                    <strong>${p.fio}</strong> (запрос: ${getRoleText(p.requested_role)}${p.requested_workshop ? ' (' + getDepartmentText(p.requested_workshop) + ')' : ''})<br>
                    <select id="assign-role-${p.tg_id}">
                        <option value="actor">Актер</option>
                        <option value="workshop_worker">Работник цеха</option>
                        <option value="workshop_head">Заведующий цехом</option>
                        ${userRole === 'troupe_head' ? '<option value="troupe_head">Заведующий труппой</option>' : ''}
                    </select>
                    <select id="assign-workshop-${p.tg_id}" class="hidden">
                        <option value="costume">Костюмерный</option>
                        <option value="props">Бутафорский</option>
                        <option value="lighting">Осветительный</option>
                        <option value="sound">Звуковой</option>
                        <option value="stage">Монтировочный</option>
                    </select>
                    <button onclick="assignRole(${p.tg_id})">Назначить</button>
                    <button onclick="rejectUser(${p.tg_id})">Отклонить</button>
                `;
                list.appendChild(div);
                document.getElementById(`assign-role-${p.tg_id}`).addEventListener('change', function() {
                    const wsSelect = document.getElementById(`assign-workshop-${p.tg_id}`);
                    if (this.value.includes('workshop')) wsSelect.classList.remove('hidden');
                    else wsSelect.classList.add('hidden');
                });
            });
            if (filteredPending.length === 0) {
                list.innerHTML = '<p>Нет неподтверждённых заявок</p>';
            }
        }
        async function assignRole(tg_id) {
            const roleSelect = document.getElementById(`assign-role-${tg_id}`);
            const role = roleSelect.value;
            const workshopSelect = document.getElementById(`assign-workshop-${p.tg_id}`);
            const workshop = role.includes('workshop') ? workshopSelect.value : null;
            try {
                const response = await apiFetch('/assign_role', 'POST', { tg_id, role, workshop });
                if (response.ok) {
                    if (tg_id === user.id) {
                        await loadUser();
                        hideConfirmShowMenu();
                        updateMenuByRole();
                    }
                    tg.showAlert(`Роль назначена: ${getRoleText(role)}${workshop ? ' (' + getDepartmentText(workshop) + ')' : ''}`);
                    loadPendingList();
                } else {
                    tg.showAlert('Ошибка');
                }
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        async function rejectUser(tg_id) {
            try {
                const response = await apiFetch('/reject_user', 'POST', { tg_id });
                if (response.ok) {
                    tg.showAlert('Заявка отклонена');
                    loadPendingList();
                } else {
                    tg.showAlert('Ошибка');
                }
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        function manageUsers() {
            if (userRole !== 'troupe_head') {
                tg.showAlert('Доступ только для заведующего труппой');
                return;
            }
            hideAllSections();
            document.getElementById('manage-users').classList.remove('hidden');
            loadUsersList();
            tg.BackButton.show().onClick(backToAdminPanel);
        }
        async function loadUsersList() {
            await loadParticipants();
            const list = document.getElementById('users-list');
            list.innerHTML = '';
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.innerHTML = `
                    <strong>${p.fio}</strong> (${getRoleText(p.role)}${p.workshop ? ' (' + getDepartmentText(p.workshop) + ')' : ''})<br>
                    <select id="change-role-${p.tg_id}">
                        <option value="${p.role}" selected>Текущая: ${getRoleText(p.role)}</option>
                        <option value="actor">Актер</option>
                        <option value="workshop_worker">Работник цеха</option>
                        <option value="workshop_head">Заведующий цехом</option>
                        <option value="troupe_head">Заведующий труппой</option>
                    </select>
                    <select id="change-workshop-${p.tg_id}" ${!p.role.includes('workshop') ? 'class="hidden"' : ''}>
                        <option value="${p.workshop || ''}" selected>${p.workshop ? getDepartmentText(p.workshop) : 'Не назначен'}</option>
                        <option value="costume">Костюмерный</option>
                        <option value="props">Бутафорский</option>
                        <option value="lighting">Осветительный</option>
                        <option value="sound">Звуковой</option>
                        <option value="stage">Монтировочный</option>
                    </select>
                    <button onclick="changeRole(${p.tg_id})">Изменить</button>
                    <button onclick="removeUser(${p.tg_id})">Удалить</button>
                `;
                list.appendChild(div);
                document.getElementById(`change-role-${p.tg_id}`).addEventListener('change', function() {
                    const wsSelect = document.getElementById(`change-workshop-${p.tg_id}`);
                    if (this.value.includes('workshop')) wsSelect.classList.remove('hidden');
                    else wsSelect.classList.add('hidden');
                });
            });
            if (participants.length === 0) {
                list.innerHTML = '<p>Нет пользователей</p>';
            }
        }
        async function changeRole(tg_id) {
            const roleSelect = document.getElementById(`change-role-${tg_id}`);
            const role = roleSelect.value;
            const workshopSelect = document.getElementById(`change-workshop-${tg_id}`);
            const workshop = role.includes('workshop') ? workshopSelect.value : null;
            try {
                const response = await apiFetch('/change_role', 'POST', { tg_id, role, workshop });
                if (response.ok) {
                    if (tg_id === user.id) {
                        userRole = role;
                        userWorkshop = workshop;
                        updateMenuByRole();
                    }
                    tg.showAlert('Роль изменена');
                    loadUsersList();
                } else {
                    tg.showAlert('Ошибка');
                }
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        async function removeUser(tg_id) {
            try {
                const response = await apiFetch('/remove_user', 'POST', { tg_id });
                if (response.ok) {
                    tg.showAlert('Пользователь удалён');
                    loadUsersList();
                } else {
                    tg.showAlert('Ошибка');
                }
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        function manageEvents() {
            if (userRole !== 'troupe_head') return;
            hideAllSections();
            document.getElementById('manage-events').classList.remove('hidden');
            loadManageEvents();
            tg.BackButton.show().onClick(backToAdminPanel);
        }
        async function loadManageEvents() {
            await loadEvents();
            const list = document.getElementById('events-manage-list');
            list.innerHTML = '';
            events.forEach(e => {
                const div = document.createElement('div');
                div.className = 'event';
                div.innerHTML = `
                    <strong>${e.title}</strong><br>
                    Начало: ${formatDate(e.datetime)}<br>
                    Конец: ${formatDate(e.end_datetime)}<br>
                    <div class="task-actions">
                        <button onclick="editEvent(${e.id})">Редактировать</button>
                        <button onclick="deleteEvent(${e.id})">Удалить</button>
                    </div>
                `;
                list.appendChild(div);
            });
            if (events.length === 0) {
                list.innerHTML = '<p>Событий нет</p>';
            }
        }
        function editEvent(id) {
            document.getElementById('manage-events').classList.add('hidden');
            document.getElementById('create-event').classList.remove('hidden');
            document.getElementById('event-form-title').textContent = 'Редактировать событие';
            currentEditEventId = id;
            const event = events.find(e => e.id === id);
            if (!event) return;
            document.getElementById('event-title').value = event.title;
            document.getElementById('event-datetime').value = formatForInput(event.datetime);
            document.getElementById('event-end-datetime').value = formatForInput(event.end_datetime);
            document.getElementById('event-type').value = event.type;
            document.getElementById('event-description').value = event.description || '';
            renderParticipantsList(event.participants);
            initFlatpickr(false); // Без minDate для редактирования
            tg.BackButton.show().onClick(cancelEventEdit);
        }
        async function deleteEvent(id) {
            try {
                const response = await apiFetch(`/events/${id}`, 'DELETE');
                if (response.ok) {
                    tg.showAlert('Событие удалено');
                    loadManageEvents();
                } else {
                    tg.showAlert('Ошибка');
                }
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        function manageTasks() {
            if (userRole !== 'troupe_head') return;
            hideAllSections();
            document.getElementById('manage-tasks').classList.remove('hidden');
            loadManageTasks();
            tg.BackButton.show().onClick(backToAdminPanel);
        }
        async function loadManageTasks() {
            await loadTasksData();
            const list = document.getElementById('tasks-manage-list');
            list.innerHTML = '';
            tasks.forEach(t => {
                const div = document.createElement('div');
                div.className = 'task';
                div.innerHTML = `
                    <strong>${t.title}</strong> (${getDepartmentText(t.department)})<br>
                    Срок: ${t.deadline}<br>
                    <div class="task-actions">
                        <button onclick="editTask(${t.id})">Редактировать</button>
                        <button onclick="deleteTask(${t.id})">Удалить</button>
                    </div>
                `;
                list.appendChild(div);
            });
            if (tasks.length === 0) {
                list.innerHTML = '<p>Задач нет</p>';
            }
        }
        function editTask(id) {
            // Добавьте форму редактирования задачи аналогично событиям, если нужно
            tg.showAlert(`Редактирование задачи ${id} (добавьте форму для реального редактирования)`);
        }
        async function deleteTask(id) {
            try {
                const response = await apiFetch(`/tasks/${id}`, 'DELETE');
                if (response.ok) {
                    tg.showAlert('Задача удалена');
                    loadManageTasks();
                } else {
                    tg.showAlert('Ошибка');
                }
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        // Загрузка данных
        async function loadEvents() {
            try {
                const response = await apiFetch('/events');
                events = await response.json();
            } catch (e) {
                console.error(e);
            }
        }
        async function loadTasksData() {
            try {
                const response = await apiFetch('/tasks');
                tasks = await response.json();
            } catch (e) {
                console.error(e);
            }
        }
        async function loadParticipants() {
            try {
                const response = await apiFetch('/users');
                participants = await response.json();
            } catch (e) {
                console.error(e);
            }
        }
        async function loadPendingUsers() {
            try {
                const response = await apiFetch('/pending_users');
                pendingUsers = await response.json();
            } catch (e) {
                console.error(e);
            }
        }
        // Вспомогательные функции
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        function formatForInput(dateStr) {
            const d = new Date(dateStr);
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const year = d.getFullYear();
            const hours = d.getHours().toString().padStart(2, '0');
            const minutes = d.getMinutes().toString().padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }
        function parseDate(dateStr) {
            const [datePart, timePart] = dateStr.split(' ');
            const [day, month, year] = datePart.split('.');
            const [hours, minutes] = timePart.split(':');
            return new Date(year, month - 1, day, hours, minutes);
        }
        function formatToISO(dateStr) {
            const [datePart, timePart] = dateStr.split(' ');
            const [day, month, year] = datePart.split('.');
            const [hours, minutes] = timePart.split(':');
            return new Date(year, month - 1, day, hours, minutes).toISOString();
        }
        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        }
        function getStatusText(status) {
            switch (status) {
                case 'confirmed': return 'Подтверждено';
                case 'cancelled': return 'Отменено';
                default: return 'Запланировано';
            }
        }
        function getTypeText(type) {
            switch (type) {
                case 'rehearsal': return 'Репетиция';
                case 'performance': return 'Спектакль';
                case 'meeting': return 'Собрание';
                case 'other': return 'Другое';
                default: return type;
            }
        }
        function getRoleText(role) {
            switch (role) {
                case 'troupe_head': return 'Заведующий труппой';
                case 'workshop_head': return 'Заведующий цехом';
                case 'actor': return 'Актер';
                case 'workshop_worker': return 'Работник цеха';
                default: return 'Не назначено';
            }
        }
        function getDepartmentText(dept) {
            switch (dept) {
                case 'costume': return 'Костюмерный';
                case 'props': return 'Бутафорский';
                case 'lighting': return 'Осветительный';
                case 'sound': return 'Звуковой';
                case 'stage': return 'Монтировочный';
                default: return dept;
            }
        }
        // Запуск
        init();
    </script>
</body>
</html>
