<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Театральный планировщик</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); transition: background 0.3s, color 0.3s; }
        .container { max-width: 400px; margin: 0 auto; }
        h1, h2 { text-align: center; }
        button { width: 100%; padding: 12px; margin: 10px 0; background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); box-sizing: border-box; }
        .event, .task { background: var(--tg-theme-secondary-bg-color); padding: 10px; margin: 10px 0; border-radius: 8px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none; }
        .error { color: var(--tg-theme-destructive-text-color); }
        .participant { display: flex; align-items: center; margin: 5px 0; }
        .participant input[type="checkbox"] { width: auto; margin-right: 10px; }
        .stats-table, .repertoire-table, .tasks-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .stats-table th, .stats-table td, .repertoire-table th, .repertoire-table td, .tasks-table th, .tasks-table td { padding: 8px; border: 1px solid var(--tg-theme-hint-color); text-align: left; font-size: 0.9em; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        .nav-buttons button { width: 48%; }
        .task-actions { display: flex; justify-content: space-around; margin-top: 10px; }
        .task-actions button { width: 45%; padding: 6px; font-size: 0.8em; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .status.planned { background: #fff3cd; color: #856404; }
        .status.confirmed { background: #d4edda; color: #155724; }
        .status.cancelled { background: #f8d7da; color: #721c24; }
        #user-info { text-align: center; margin: 15px 0; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Театральный планировщик</h1>
        <div id="user-info"></div>

        <!-- Форма подтверждения -->
        <div id="confirm-section">
            <h2>Подтверждение аккаунта</h2>
            <p>Введите ваше ФИО для доступа к приложению:</p>
            <input type="text" id="fio-input" placeholder="Фамилия Имя Отчество">
            <button onclick="sendForConfirmation()">Отправить на подтверждение</button>
            <p class="error hidden" id="error-msg">Пожалуйста, заполните ФИО</p>
            <p>Данные отправятся администратору. После одобрения вы получите полный доступ.</p>
        </div>

        <!-- Главное меню -->
        <div id="main-menu" class="hidden">
            <button onclick="showSchedule()">Моё расписание</button>
            <button onclick="startCreateEvent()">Создать событие</button>
            <button onclick="startWorkshopTasks()">Задачи цехам</button>
            <button onclick="showRepertoire()">Репертуар на месяц</button>
            <button onclick="showStats()">Статистика</button>
        </div>

        <!-- Расписание -->
        <div id="schedule" class="hidden">
            <h2>Персональное расписание</h2>
            <select id="period-select" onchange="loadSchedule(this.value)">
                <option value="today">Сегодня</option>
                <option value="tomorrow">Завтра</option>
                <option value="week">Неделя</option>
                <option value="month">Месяц</option>
            </select>
            <div id="events-list"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()">Назад</button>
            </div>
        </div>

        <!-- Создание события -->
        <div id="create-event" class="hidden">
            <h2>Создать событие</h2>
            <input type="text" id="event-title" placeholder="Название события">
            <input type="text" id="event-datetime" placeholder="Дата и время">
            <select id="event-type">
                <option value="rehearsal">Репетиция</option>
                <option value="performance">Спектакль</option>
                <option value="meeting">Собрание</option>
                <option value="other">Другое</option>
            </select>
            <textarea id="event-description" placeholder="Описание (необязательно)"></textarea>
            <div id="participants-list"></div>
            <div class="nav-buttons">
                <button onclick="saveEvent()">Сохранить</button>
                <button onclick="backToMenu()">Отмена</button>
            </div>
        </div>

        <!-- Задачи цехам -->
        <div id="workshop-tasks" class="hidden">
            <h2>Задачи цехам</h2>
            <button onclick="startCreateTask()">Создать новую задачу</button>
            <div id="tasks-list"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()">Назад</button>
            </div>
        </div>

        <!-- Создание задачи -->
        <div id="create-task" class="hidden">
            <h2>Новая задача для цеха</h2>
            <input type="text" id="task-title" placeholder="Название задачи">
            <select id="task-department">
                <option value="costume">Костюмерный</option>
                <option value="props">Бутафорский</option>
                <option value="lighting">Осветительный</option>
                <option value="sound">Звуковой</option>
                <option value="stage">Монтировочный</option>
            </select>
            <input type="text" id="task-deadline" placeholder="Срок выполнения">
            <textarea id="task-description" placeholder="Подробное описание"></textarea>
            <div class="nav-buttons">
                <button onclick="saveTask()">Сохранить</button>
                <button onclick="backToWorkshopTasks()">Отмена</button>
            </div>
        </div>

        <!-- Репертуар на месяц -->
        <div id="repertoire" class="hidden">
            <h2>Репертуар на месяц</h2>
            <div id="repertoire-table-container"></div>
            <button onclick="exportRepertoire()">Экспорт в Excel</button>
            <div class="nav-buttons">
                <button onclick="backToMenu()">Назад</button>
            </div>
        </div>

        <!-- Статистика -->
        <div id="stats" class="hidden">
            <h2>Статистика</h2>
            <div id="stats-content"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()">Назад</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const user = tg.initDataUnsafe.user || { id: 123456, username: 'testuser' };
        let isConfirmed = localStorage.getItem('confirmed') === 'true';
        let userFIO = localStorage.getItem('user_fio') || '';
        let events = JSON.parse(localStorage.getItem('events') || '[]');
        let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        let participants = JSON.parse(localStorage.getItem('participants') || '[]'); // список всех актёров с tg_id и fio

        // Инициализация
        function init() {
            if (isConfirmed && userFIO) {
                hideConfirmShowMenu();
            } else {
                document.getElementById('confirm-section').classList.remove('hidden');
            }
            loadParticipants(); // Загрузка списка участников (в реальности — с сервера)
        }

        function hideConfirmShowMenu() {
            document.getElementById('confirm-section').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('user-info').textContent = `Добро пожаловать, ${userFIO}!`;
        }

        // Подтверждение ФИО
        function sendForConfirmation() {
            const fio = document.getElementById('fio-input').value.trim();
            if (!fio) {
                document.getElementById('error-msg').classList.remove('hidden');
                return;
            }

            // Отправка админу
            tg.sendData(JSON.stringify({
                action: 'request_confirmation',
                tg_id: user.id,
                username: user.username || '',
                fio: fio
            }));

            // Симуляция одобрения для разработки
            localStorage.setItem('user_fio', fio);
            localStorage.setItem('confirmed', 'true');
            isConfirmed = true;
            userFIO = fio;

            tg.showAlert('Заявка отправлена администратору. Доступ открыт (симуляция).');
            hideConfirmShowMenu();
            tg.HapticFeedback.notificationOccurred('success');
        }

        // Проверка подтверждения
        function requireConfirmation() {
            if (!isConfirmed) {
                tg.showAlert('Сначала подтвердите аккаунт');
                return false;
            }
            return true;
        }

        // Навигация
        function backToMenu() {
            document.querySelectorAll('.hidden').forEach(el => el.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
            tg.BackButton.hide();
        }

        function backToWorkshopTasks() {
            document.getElementById('create-task').classList.add('hidden');
            document.getElementById('workshop-tasks').classList.remove('hidden');
        }

        // ===== РАСПИСАНИЕ =====
        function showSchedule() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('schedule').classList.remove('hidden');
            loadSchedule('today');
            tg.BackButton.show().onClick(backToMenu);
        }

        function loadSchedule(period) {
            const list = document.getElementById('events-list');
            list.innerHTML = '';
            const now = new Date();
            const filtered = events.filter(e => {
                const eventDate = new Date(e.datetime);
                const participant = e.participants.some(p => p.id === user.id);
                if (!participant) return false;

                switch (period) {
                    case 'today': return isSameDay(eventDate, now);
                    case 'tomorrow': return isSameDay(eventDate, new Date(now.setDate(now.getDate() + 1)));
                    case 'week': return eventDate >= now && eventDate <= new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7);
                    case 'month': return eventDate.getMonth() === now.getMonth() && eventDate.getFullYear() === now.getFullYear();
                    default: return true;
                }
            });

            if (filtered.length === 0) {
                list.innerHTML = '<p>На выбранный период событий нет.</p>';
                return;
            }

            filtered.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            filtered.forEach(e => {
                const div = document.createElement('div');
                div.className = 'event';
                div.innerHTML = `
                    <strong>${e.title}</strong><br>
                    ${formatDate(e.datetime)}<br>
                    <span class="status ${e.status || 'planned'}">${getStatusText(e.status || 'planned')}</span>
                `;
                list.appendChild(div);
            });
        }

        // ===== СОЗДАНИЕ СОБЫТИЯ =====
        function startCreateEvent() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('create-event').classList.remove('hidden');

            flatpickr("#event-datetime", {
                enableTime: true,
                dateFormat: "d.m.Y H:i",
                locale: "ru",
                minDate: "today"
            });

            renderParticipantsList();
            tg.BackButton.show().onClick(backToMenu);
        }

        function renderParticipantsList() {
            const container = document.getElementById('participants-list');
            container.innerHTML = '<h3>Участники:</h3>';
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.innerHTML = `
                    <input type="checkbox" id="part-${p.id}" value="${p.id}">
                    <label for="part-${p.id}">${p.fio}</label>
                `;
                container.appendChild(div);
            });
        }

        function saveEvent() {
            const title = document.getElementById('event-title').value.trim();
            const datetime = document.getElementById('event-datetime').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value.trim();

            if (!title || !datetime) {
                tg.showAlert('Заполните название и дату/время');
                return;
            }

            const selectedParticipants = Array.from(document.querySelectorAll('#participants-list input:checked'))
                .map(cb => ({ id: parseInt(cb.value), fio: cb.parentNode.querySelector('label').textContent }));

            const newEvent = {
                id: Date.now(),
                title,
                datetime,
                type,
                description,
                participants: selectedParticipants,
                status: 'planned',
                createdBy: user.id
            };

            events.push(newEvent);
            localStorage.setItem('events', JSON.stringify(events));

            tg.showAlert('Событие создано');
            backToMenu();
        }

        // ===== ЗАДАЧИ ЦЕХАМ =====
        function startWorkshopTasks() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('workshop-tasks').classList.remove('hidden');
            loadTasks();
            tg.BackButton.show().onClick(backToMenu);
        }

        function startCreateTask() {
            hideAllSections();
            document.getElementById('create-task').classList.remove('hidden');

            flatpickr("#task-deadline", {
                dateFormat: "d.m.Y",
                locale: "ru",
                minDate: "today"
            });

            tg.BackButton.show().onClick(backToWorkshopTasks);
        }

        function saveTask() {
            const title = document.getElementById('task-title').value.trim();
            const department = document.getElementById('task-department').value;
            const deadline = document.getElementById('task-deadline').value;
            const description = document.getElementById('task-description').value.trim();

            if (!title || !deadline) {
                tg.showAlert('Заполните название и срок');
                return;
            }

            const newTask = {
                id: Date.now(),
                title,
                department,
                deadline,
                description,
                status: 'planned',
                createdBy: userFIO
            };

            tasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(tasks));

            tg.showAlert('Задача создана');
            startWorkshopTasks();
        }

        function loadTasks() {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            if (tasks.length === 0) {
                list.innerHTML = '<p>Задач пока нет</p>';
                return;
            }

            tasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
            tasks.forEach(t => {
                const div = document.createElement('div');
                div.className = 'task';
                div.innerHTML = `
                    <strong>${t.title}</strong> (${t.department})<br>
                    Срок: ${t.deadline}<br>
                    <span class="status ${t.status}">${getStatusText(t.status)}</span>
                    <div class="task-actions">
                        <button onclick="completeTask(${t.id})">Выполнено</button>
                        <button onclick="cancelTask(${t.id})">Отменить</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function completeTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) task.status = 'confirmed';
            localStorage.setItem('tasks', JSON.stringify(tasks));
            loadTasks();
        }

        function cancelTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) task.status = 'cancelled';
            localStorage.setItem('tasks', JSON.stringify(tasks));
            loadTasks();
        }

        // ===== РЕПЕРТУАР =====
        function showRepertoire() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('repertoire').classList.remove('hidden');
            renderRepertoireTable();
            tg.BackButton.show().onClick(backToMenu);
        }

        function renderRepertoireTable() {
            const container = document.getElementById('repertoire-table-container');
            const performances = events.filter(e => e.type === 'performance');
            if (performances.length === 0) {
                container.innerHTML = '<p>Спектаклей в репертуаре нет</p>';
                return;
            }

            let table = '<table class="repertoire-table"><thead><tr><th>Дата</th><th>Спектакль</th><th>Статус</th></tr></thead><tbody>';
            performances.forEach(p => {
                table += `<tr><td>${formatDate(p.datetime)}</td><td>${p.title}</td><td><span class="status ${p.status || 'planned'}">${getStatusText(p.status || 'planned')}</span></td></tr>`;
            });
            table += '</tbody></table>';
            container.innerHTML = table;
        }

        function exportRepertoire() {
            const wb = XLSX.utils.book_new();
            const data = events.filter(e => e.type === 'performance').map(e => ({
                Дата: formatDate(e.datetime),
                Спектакль: e.title,
                Статус: getStatusText(e.status || 'planned')
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Репертуар");
            XLSX.writeFile(wb, "repertoire.xlsx");
        }

        // ===== СТАТИСТИКА =====
        function showStats() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('stats').classList.remove('hidden');
            renderStats();
            tg.BackButton.show().onClick(backToMenu);
        }

        function renderStats() {
            const content = document.getElementById('stats-content');
            const totalEvents = events.length;
            const rehearsals = events.filter(e => e.type === 'rehearsal').length;
            const performances = events.filter(e => e.type === 'performance').length;
            const myEvents = events.filter(e => e.participants.some(p => p.id === user.id)).length;

            content.innerHTML = `
                <p>Всего событий: ${totalEvents}</p>
                <p>Репетиций: ${rehearsals}</p>
                <p>Спектаклей: ${performances}</p>
                <p>Ваши события: ${myEvents}</p>
                <p>Задач цехам: ${tasks.length}</p>
            `;
        }

        // Вспомогательные функции
        function hideAllSections() {
            document.querySelectorAll('#main-menu, #schedule, #create-event, #workshop-tasks, #create-task, #repertoire, #stats')
                .forEach(el => el.classList.add('hidden'));
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        }

        function getStatusText(status) {
            switch (status) {
                case 'confirmed': return 'Подтверждено';
                case 'cancelled': return 'Отменено';
                default: return 'Запланировано';
            }
        }

        function loadParticipants() {
            // В реальном приложении — запрос к бэкенду
            // Здесь заглушка
            if (participants.length === 0) {
                participants = [
                    { id: user.id, fio: userFIO || 'Тестовый актёр' },
                    { id: 999999, fio: 'Иванов Иван Иванович' },
                    { id: 999998, fio: 'Петрова Анна Сергеевна' }
                ];
                localStorage.setItem('participants', JSON.stringify(participants));
            }
        }

        // Запуск
        init();
    </script>
</body>
</html>
