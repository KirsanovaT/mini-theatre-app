<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Театральный планировщик</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); transition: background 0.3s, color 0.3s; }
        .container { max-width: 400px; margin: 0 auto; }
        h1, h2 { text-align: center; }
        button { width: 100%; padding: 12px; margin: 10px 0; background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); box-sizing: border-box; }
        .event, .task { background: var(--tg-theme-secondary-bg-color); padding: 10px; margin: 10px 0; border-radius: 8px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none; }
        .error { color: var(--tg-theme-destructive-text-color); }
        .participant { display: flex; align-items: center; margin: 5px 0; }
        .participant input[type="checkbox"] { width: auto; margin-right: 10px; }
        .stats-table, .repertoire-table, .tasks-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .stats-table th, .stats-table td, .repertoire-table th, .repertoire-table td, .tasks-table th, .tasks-table td { padding: 8px; border: 1px solid var(--tg-theme-hint-color); text-align: left; font-size: 0.9em; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        .nav-buttons button { width: 48%; }
        .task-actions { display: flex; justify-content: space-around; margin-top: 10px; }
        .task-actions button { width: 45%; padding: 6px; font-size: 0.8em; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .status.planned { background: #fff3cd; color: #856404; }
        .status.confirmed { background: #d4edda; color: #155724; }
        .status.cancelled { background: #f8d7da; color: #721c24; }
        #user-info { text-align: center; margin: 15px 0; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Театральный планировщик</h1>
        <div id="user-info"></div>

        <!-- Форма подтверждения -->
        <div id="confirm-section">
            <h2>Подтверждение аккаунта</h2>
            <p>Введите ваше ФИО для доступа к приложению:</p>
            <input type="text" id="fio-input" placeholder="Фамилия Имя Отчество">
            <select id="role-request">
                <option value="actor">Актер</option>
                <option value="workshop_worker">Работник цеха</option>
                <option value="workshop_head">Заведующий цехом</option>
            </select>
            <select id="workshop-request" class="hidden">
                <option value="costume">Костюмерный</option>
                <option value="props">Бутафорский</option>
                <option value="lighting">Осветительный</option>
                <option value="sound">Звуковой</option>
                <option value="stage">Монтировочный</option>
            </select>
            <button onclick="sendForConfirmation()">Отправить на подтверждение</button>
            <p class="error hidden" id="error-msg">Пожалуйста, заполните ФИО и роль</p>
            <p>Данные отправятся администратору. После одобрения вы получите доступ.</p>
        </div>

        <!-- Главное меню -->
        <div id="main-menu" class="hidden">
            <button onclick="showSchedule()">Расписание</button>
            <button onclick="startCreateEvent()">Создать событие</button>
            <button onclick="startWorkshopTasks()">Задачи цехам</button>
            <button onclick="showRepertoire()">Репертуар на месяц</button>
            <button onclick="showStats()">Статистика</button>
        </div>

        <!-- Админ-панель (для troupe_head и workshop_head) -->
        <div id="admin-panel" class="hidden">
            <h2>Админ-панель</h2>
            <button onclick="showPendingConfirmations()">Неподтверждённые пользователи</button>
            <button onclick="manageUsers()">Управление пользователями</button>
            <button onclick="manageEvents()">Управление событиями</button>
            <button onclick="manageTasks()">Управление задачами</button>
        </div>

        <!-- Неподтверждённые пользователи -->
        <div id="pending-confirmations" class="hidden">
            <h2>Неподтверждённые пользователи</h2>
            <div id="pending-list"></div>
            <div class="nav-buttons">
                <button onclick="backToAdminPanel()">Назад</button>
            </div>
        </div>

        <!-- Управление пользователями -->
        <div id="manage-users" class="hidden">
            <h2>Управление пользователями</h2>
            <div id="users-list"></div>
            <div class="nav-buttons">
                <button onclick="backToAdminPanel()">Назад</button>
            </div>
        </div>

        <!-- Управление событиями -->
        <div id="manage-events" class="hidden">
            <h2>Управление событиями</h2>
            <div id="events-manage-list"></div>
            <div class="nav-buttons">
                <button onclick="backToAdminPanel()">Назад</button>
            </div>
        </div>

        <!-- Управление задачами -->
        <div id="manage-tasks" class="hidden">
            <h2>Управление задачами</h2>
            <div id="tasks-manage-list"></div>
            <div class="nav-buttons">
                <button onclick="backToAdminPanel()">Назад</button>
            </div>
        </div>

        <!-- Расписание -->
        <div id="schedule" class="hidden">
            <h2>Расписание</h2>
            <select id="period-select" onchange="loadSchedule(this.value)">
                <option value="today">Сегодня</option>
                <option value="tomorrow">Завтра</option>
                <option value="week">Неделя</option>
                <option value="month">Месяц</option>
            </select>
            <div id="events-list"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()">Назад</button>
            </div>
        </div>

        <!-- Создание события -->
        <div id="create-event" class="hidden">
            <h2>Создать событие</h2>
            <input type="text" id="event-title" placeholder="Название события">
            <input type="text" id="event-datetime" placeholder="Дата и время">
            <select id="event-type">
                <option value="rehearsal">Репетиция</option>
                <option value="performance">Спектакль</option>
                <option value="meeting">Собрание</option>
                <option value="other">Другое</option>
            </select>
            <textarea id="event-description" placeholder="Описание (необязательно)"></textarea>
            <div id="participants-list"></div>
            <div class="nav-buttons">
                <button onclick="saveEvent()">Сохранить</button>
                <button onclick="backToMenu()">Отмена</button>
            </div>
        </div>

        <!-- Задачи цехам -->
        <div id="workshop-tasks" class="hidden">
            <h2>Задачи цехам</h2>
            <button onclick="startCreateTask()">Создать новую задачу</button>
            <div id="tasks-list"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()">Назад</button>
            </div>
        </div>

        <!-- Создание задачи -->
        <div id="create-task" class="hidden">
            <h2>Новая задача для цеха</h2>
            <input type="text" id="task-title" placeholder="Название задачи">
            <select id="task-department">
                <option value="costume">Костюмерный</option>
                <option value="props">Бутафорский</option>
                <option value="lighting">Осветительный</option>
                <option value="sound">Звуковой</option>
                <option value="stage">Монтировочный</option>
            </select>
            <input type="text" id="task-deadline" placeholder="Срок выполнения">
            <textarea id="task-description" placeholder="Подробное описание"></textarea>
            <div class="nav-buttons">
                <button onclick="saveTask()">Сохранить</button>
                <button onclick="backToWorkshopTasks()">Отмена</button>
            </div>
        </div>

        <!-- Репертуар на месяц -->
        <div id="repertoire" class="hidden">
            <h2>Репертуар на месяц</h2>
            <div id="repertoire-table-container"></div>
            <button onclick="exportRepertoire()">Экспорт в Excel</button>
            <div class="nav-buttons">
                <button onclick="backToMenu()">Назад</button>
            </div>
        </div>

        <!-- Статистика -->
        <div id="stats" class="hidden">
            <h2>Статистика</h2>
            <div id="stats-content"></div>
            <div class="nav-buttons">
                <button onclick="backToMenu()">Назад</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const user = tg.initDataUnsafe.user || { id: 123456, username: 'testuser' };
        let isConfirmed = localStorage.getItem('confirmed') === 'true';
        let userFIO = localStorage.getItem('user_fio') || '';
        let userRole = localStorage.getItem('user_role') || 'pending';
        let userWorkshop = localStorage.getItem('user_workshop') || null;
        let events = JSON.parse(localStorage.getItem('events') || '[]');
        let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        let participants = JSON.parse(localStorage.getItem('participants') || '[]'); // все пользователи
        let pendingUsers = JSON.parse(localStorage.getItem('pending_users') || '[]'); // для симуляции неподтвержденных

        // Инициализация
        function init() {
            document.getElementById('role-request').addEventListener('change', function() {
                const workshopSelect = document.getElementById('workshop-request');
                if (this.value.includes('workshop')) {
                    workshopSelect.classList.remove('hidden');
                } else {
                    workshopSelect.classList.add('hidden');
                }
            });

            if (isConfirmed && userFIO) {
                hideConfirmShowMenu();
                updateMenuByRole();
            } else {
                document.getElementById('confirm-section').classList.remove('hidden');
            }
            loadParticipants(); // Заглушка
        }

        function hideConfirmShowMenu() {
            document.getElementById('confirm-section').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('user-info').textContent = `Добро пожаловать, ${userFIO}! Роль: ${getRoleText(userRole)}${userWorkshop ? ' (' + getDepartmentText(userWorkshop) + ')' : ''}`;
        }

        function updateMenuByRole() {
            if (['troupe_head', 'workshop_head'].includes(userRole)) {
                document.getElementById('admin-panel').classList.remove('hidden');
            }
            // Скрыть кнопки, если нет прав
            if (!['actor', 'troupe_head'].includes(userRole)) {
                document.querySelector('button[onclick="startCreateEvent()"]').classList.add('hidden');
            }
            if (userRole === 'actor') {
                document.querySelector('button[onclick="startWorkshopTasks()"]').classList.add('hidden');
            }
            if (userRole === 'workshop_worker') {
                document.querySelector('button[onclick="showSchedule()"]').textContent = 'Моё расписание';
                document.querySelector('button[onclick="startCreateEvent()"]').classList.add('hidden');
            } else {
                document.querySelector('button[onclick="showSchedule()"]').textContent = 'Расписание театра';
            }
        }

        // Подтверждение с ролью
        function sendForConfirmation() {
            const fio = document.getElementById('fio-input').value.trim();
            const requestedRole = document.getElementById('role-request').value;
            const requestedWorkshop = requestedRole.includes('workshop') ? document.getElementById('workshop-request').value : null;

            if (!fio || (requestedRole.includes('workshop') && !requestedWorkshop)) {
                document.getElementById('error-msg').classList.remove('hidden');
                return;
            }

            tg.sendData(JSON.stringify({
                action: 'request_confirmation',
                tg_id: user.id,
                username: user.username || '',
                fio: fio,
                requested_role: requestedRole,
                requested_workshop: requestedWorkshop
            }));

            // Симуляция: добавляем в pending
            pendingUsers.push({
                tg_id: user.id,
                fio: fio,
                requested_role: requestedRole,
                requested_workshop: requestedWorkshop
            });
            localStorage.setItem('pending_users', JSON.stringify(pendingUsers));

            tg.showAlert('Заявка отправлена. Ждите подтверждения (симуляция: добавлено в pending).');
            // Для теста не открываем меню сразу
        }

        // Проверка подтверждения
        function requireConfirmation() {
            if (!isConfirmed) {
                tg.showAlert('Сначала подтвердите аккаунт');
                return false;
            }
            return true;
        }

        // Навигация
        function backToMenu() {
            hideAllSections();
            document.getElementById('main-menu').classList.remove('hidden');
            if (['troupe_head', 'workshop_head'].includes(userRole)) {
                document.getElementById('admin-panel').classList.remove('hidden');
            }
            tg.BackButton.hide();
        }

        function backToWorkshopTasks() {
            document.getElementById('create-task').classList.add('hidden');
            document.getElementById('workshop-tasks').classList.remove('hidden');
        }

        function backToAdminPanel() {
            hideAllSections();
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
        }

        function hideAllSections() {
            document.querySelectorAll('#main-menu, #admin-panel, #schedule, #create-event, #workshop-tasks, #create-task, #repertoire, #stats, #pending-confirmations, #manage-users, #manage-events, #manage-tasks')
                .forEach(el => el.classList.add('hidden'));
        }

        // ===== РАСПИСАНИЕ =====
        function showSchedule() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('schedule').classList.remove('hidden');
            loadSchedule('today');
            tg.BackButton.show().onClick(backToMenu);
        }

        function loadSchedule(period) {
            const list = document.getElementById('events-list');
            list.innerHTML = '';
            const now = new Date();
            let filtered = events.filter(e => {
                const eventDate = new Date(e.datetime);
                let matchesPeriod = false;
                switch (period) {
                    case 'today':
                        matchesPeriod = isSameDay(eventDate, now);
                        break;
                    case 'tomorrow':
                        const tomorrow = new Date(now);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        matchesPeriod = isSameDay(eventDate, tomorrow);
                        break;
                    case 'week':
                        const weekEnd = new Date(now);
                        weekEnd.setDate(weekEnd.getDate() + 7);
                        matchesPeriod = eventDate >= now && eventDate <= weekEnd;
                        break;
                    case 'month':
                        matchesPeriod = eventDate.getMonth() === now.getMonth() && eventDate.getFullYear() === now.getFullYear();
                        break;
                    default:
                        matchesPeriod = true;
                }
                return matchesPeriod;
            });

            // Для базовых ролей - фильтр своих событий, для head - все
            if (['actor', 'workshop_worker'].includes(userRole)) {
                filtered = filtered.filter(e => e.participants.some(p => p.id === user.id));
            }

            if (filtered.length === 0) {
                list.innerHTML = '<p>На выбранный период событий нет.</p>';
                return;
            }

            filtered.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            filtered.forEach(e => {
                const div = document.createElement('div');
                div.className = 'event';
                div.innerHTML = `
                    <strong>${e.title}</strong><br>
                    ${formatDate(e.datetime)}<br>
                    Тип: ${getTypeText(e.type)}<br>
                    <span class="status ${e.status || 'planned'}">${getStatusText(e.status || 'planned')}</span>
                `;
                list.appendChild(div);
            });
        }

        // ===== СОЗДАНИЕ СОБЫТИЯ =====
        function startCreateEvent() {
            if (!requireConfirmation() || !['actor', 'troupe_head'].includes(userRole)) {
                tg.showAlert('У вас нет прав на создание событий');
                return;
            }
            hideAllSections();
            document.getElementById('create-event').classList.remove('hidden');

            flatpickr("#event-datetime", {
                enableTime: true,
                dateFormat: "d.m.Y H:i",
                locale: "ru",
                minDate: "today"
            });

            renderParticipantsList();
            tg.BackButton.show().onClick(backToMenu);
        }

        function renderParticipantsList() {
            const container = document.getElementById('participants-list');
            container.innerHTML = '<h3>Участники:</h3>';
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.innerHTML = `
                    <input type="checkbox" id="part-${p.id}" value="${p.id}">
                    <label for="part-${p.id}">${p.fio} (${getRoleText(p.role)})</label>
                `;
                container.appendChild(div);
            });
        }

        function saveEvent() {
            const title = document.getElementById('event-title').value.trim();
            const datetime = document.getElementById('event-datetime').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value.trim();

            if (!title || !datetime) {
                tg.showAlert('Заполните название и дату/время');
                return;
            }

            const selectedParticipants = Array.from(document.querySelectorAll('#participants-list input:checked'))
                .map(cb => ({
                    id: parseInt(cb.value),
                    fio: cb.nextElementSibling.textContent.split(' (')[0]
                }));

            const newEvent = {
                id: Date.now(),
                title,
                datetime,
                type,
                description,
                participants: selectedParticipants,
                status: 'planned',
                createdBy: user.id
            };

            events.push(newEvent);
            localStorage.setItem('events', JSON.stringify(events));

            tg.showAlert('Событие создано');
            backToMenu();
        }

        // ===== ЗАДАЧИ ЦЕХАМ =====
        function startWorkshopTasks() {
            if (!requireConfirmation() || !['workshop_head', 'workshop_worker', 'troupe_head'].includes(userRole)) return;
            hideAllSections();
            document.getElementById('workshop-tasks').classList.remove('hidden');
            loadTasks();
            tg.BackButton.show().onClick(backToMenu);
        }

        function loadTasks() {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            let filteredTasks = tasks;

            if (['workshop_head', 'workshop_worker'].includes(userRole)) {
                filteredTasks = tasks.filter(t => t.department === userWorkshop);
            }

            if (filteredTasks.length === 0) {
                list.innerHTML = '<p>Задач пока нет</p>';
                return;
            }

            filteredTasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
            filteredTasks.forEach(t => {
                const div = document.createElement('div');
                div.className = 'task';
                div.innerHTML = `
                    <strong>${t.title}</strong> (${getDepartmentText(t.department)})<br>
                    Срок: ${t.deadline}<br>
                    <span class="status ${t.status}">${getStatusText(t.status)}</span>
                `;
                if (['workshop_head', 'troupe_head'].includes(userRole)) {
                    div.innerHTML += `
                        <div class="task-actions">
                            <button onclick="completeTask(${t.id})">Выполнено</button>
                            <button onclick="cancelTask(${t.id})">Отменить</button>
                        </div>
                    `;
                } else if (userRole === 'workshop_worker' && t.status === 'planned') {
                    div.innerHTML += `
                        <div class="task-actions">
                            <button onclick="completeTask(${t.id})">Выполнено</button>
                        </div>
                    `;
                }
                list.appendChild(div);
            });
        }

        function startCreateTask() {
            if (!['workshop_head', 'troupe_head'].includes(userRole)) {
                tg.showAlert('У вас нет прав на создание задач');
                return;
            }
            hideAllSections();
            document.getElementById('create-task').classList.remove('hidden');

            flatpickr("#task-deadline", {
                dateFormat: "d.m.Y",
                locale: "ru",
                minDate: "today"
            });

            if (userRole === 'workshop_head') {
                document.getElementById('task-department').value = userWorkshop;
                document.getElementById('task-department').disabled = true;
            }

            tg.BackButton.show().onClick(backToWorkshopTasks);
        }

        function saveTask() {
            const title = document.getElementById('task-title').value.trim();
            let department = document.getElementById('task-department').value;
            const deadline = document.getElementById('task-deadline').value;
            const description = document.getElementById('task-description').value.trim();

            if (!title || !deadline) {
                tg.showAlert('Заполните название и срок');
                return;
            }

            if (userRole === 'workshop_head') {
                department = userWorkshop;
            }

            const newTask = {
                id: Date.now(),
                title,
                department,
                deadline,
                description,
                status: 'planned',
                createdBy: userFIO
            };

            tasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(tasks));

            tg.showAlert('Задача создана');
            startWorkshopTasks();
        }

        function completeTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) task.status = 'confirmed';
            localStorage.setItem('tasks', JSON.stringify(tasks));
            loadTasks();
        }

        function cancelTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) task.status = 'cancelled';
            localStorage.setItem('tasks', JSON.stringify(tasks));
            loadTasks();
        }

        // ===== РЕПЕРТУАР =====
        function showRepertoire() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('repertoire').classList.remove('hidden');
            renderRepertoireTable();
            tg.BackButton.show().onClick(backToMenu);
        }

        function renderRepertoireTable() {
            const container = document.getElementById('repertoire-table-container');
            const now = new Date();
            const performances = events.filter(e => e.type === 'performance' && new Date(e.datetime).getMonth() === now.getMonth());
            if (performances.length === 0) {
                container.innerHTML = '<p>Спектаклей в репертуаре нет</p>';
                return;
            }

            let table = '<table class="repertoire-table"><thead><tr><th>Дата</th><th>Спектакль</th><th>Статус</th></tr></thead><tbody>';
            performances.forEach(p => {
                table += `<tr><td>${formatDate(p.datetime)}</td><td>${p.title}</td><td><span class="status ${p.status || 'planned'}">${getStatusText(p.status || 'planned')}</span></td></tr>`;
            });
            table += '</tbody></table>';
            container.innerHTML = table;
        }

        function exportRepertoire() {
            const wb = XLSX.utils.book_new();
            const now = new Date();
            const data = events.filter(e => e.type === 'performance' && new Date(e.datetime).getMonth() === now.getMonth()).map(e => ({
                Дата: formatDate(e.datetime),
                Спектакль: e.title,
                Статус: getStatusText(e.status || 'planned')
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Репертуар");
            XLSX.writeFile(wb, "repertoire.xlsx");
        }

        // ===== СТАТИСТИКА =====
        function showStats() {
            if (!requireConfirmation()) return;
            hideAllSections();
            document.getElementById('stats').classList.remove('hidden');
            renderStats();
            tg.BackButton.show().onClick(backToMenu);
        }

        function renderStats() {
            const content = document.getElementById('stats-content');
            let totalEvents = events.length;
            let rehearsals = events.filter(e => e.type === 'rehearsal').length;
            let performances = events.filter(e => e.type === 'performance').length;
            let myEvents = events.filter(e => e.participants.some(p => p.id === user.id)).length;
            let totalTasks = tasks.length;

            if (['actor', 'workshop_worker'].includes(userRole)) {
                totalEvents = myEvents;
                rehearsals = events.filter(e => e.type === 'rehearsal' && e.participants.some(p => p.id === user.id)).length;
                performances = events.filter(e => e.type === 'performance' && e.participants.some(p => p.id === user.id)).length;
                totalTasks = tasks.filter(t => t.department === userWorkshop).length;
            } else if (userRole === 'workshop_head') {
                totalTasks = tasks.filter(t => t.department === userWorkshop).length;
            }

            content.innerHTML = `
                <p>Всего событий: ${totalEvents}</p>
                <p>Репетиций: ${rehearsals}</p>
                <p>Спектаклей: ${performances}</p>
                <p>Ваши события: ${myEvents}</p>
                <p>Задач цехам: ${totalTasks}</p>
            `;
        }

        // ===== АДМИН-ПАНЕЛЬ =====
        function showPendingConfirmations() {
            if (!['troupe_head', 'workshop_head'].includes(userRole)) return;
            hideAllSections();
            document.getElementById('pending-confirmations').classList.remove('hidden');
            loadPendingList();
            tg.BackButton.show().onClick(backToAdminPanel);
        }

        function loadPendingList() {
            const list = document.getElementById('pending-list');
            list.innerHTML = '';
            let filteredPending = pendingUsers;
            if (userRole === 'workshop_head') {
                filteredPending = pendingUsers.filter(p => p.requested_role.includes('workshop') && p.requested_workshop === userWorkshop);
            }
            filteredPending.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.innerHTML = `
                    <strong>${p.fio}</strong> (запрос: ${getRoleText(p.requested_role)}${p.requested_workshop ? ' (' + getDepartmentText(p.requested_workshop) + ')' : ''})<br>
                    <select id="assign-role-${p.tg_id}">
                        <option value="actor">Актер</option>
                        <option value="workshop_worker">Работник цеха</option>
                        <option value="workshop_head">Заведующий цехом</option>
                        ${userRole === 'troupe_head' ? '<option value="troupe_head">Заведующий труппой</option>' : ''}
                    </select>
                    <select id="assign-workshop-${p.tg_id}" class="hidden">
                        <option value="costume">Костюмерный</option>
                        <option value="props">Бутафорский</option>
                        <option value="lighting">Осветительный</option>
                        <option value="sound">Звуковой</option>
                        <option value="stage">Монтировочный</option>
                    </select>
                    <button onclick="assignRole(${p.tg_id})">Назначить</button>
                    <button onclick="rejectUser(${p.tg_id})">Отклонить</button>
                `;
                list.appendChild(div);

                document.getElementById(`assign-role-${p.tg_id}`).addEventListener('change', function() {
                    const wsSelect = document.getElementById(`assign-workshop-${p.tg_id}`);
                    if (this.value.includes('workshop')) wsSelect.classList.remove('hidden');
                    else wsSelect.classList.add('hidden');
                });
            });
            if (filteredPending.length === 0) {
                list.innerHTML = '<p>Нет неподтверждённых заявок</p>';
            }
        }

        function assignRole(tg_id) {
            const roleSelect = document.getElementById(`assign-role-${tg_id}`);
            const role = roleSelect.value;
            const workshopSelect = document.getElementById(`assign-workshop-${tg_id}`);
            const workshop = role.includes('workshop') ? workshopSelect.value : null;

            // В реале: tg.sendData({ action: 'set_role', tg_id, role, workshop })
            // Симуляция: добавляем в participants, удаляем из pending
            const pendingIndex = pendingUsers.findIndex(p => p.tg_id === tg_id);
            if (pendingIndex !== -1) {
                const userData = pendingUsers.splice(pendingIndex, 1)[0];
                participants.push({
                    id: tg_id,
                    fio: userData.fio,
                    role: role,
                    workshop: workshop
                });
                localStorage.setItem('participants', JSON.stringify(participants));
                localStorage.setItem('pending_users', JSON.stringify(pendingUsers));
            }

            // Если это текущий пользователь
            if (tg_id === user.id) {
                localStorage.setItem('user_role', role);
                localStorage.setItem('user_workshop', workshop);
                localStorage.setItem('confirmed', 'true');
                isConfirmed = true;
                userRole = role;
                userWorkshop = workshop;
                hideConfirmShowMenu();
                updateMenuByRole();
            }

            tg.showAlert(`Роль назначена: ${getRoleText(role)}${workshop ? ' (' + getDepartmentText(workshop) + ')' : ''}`);
            loadPendingList();
        }

        function rejectUser(tg_id) {
            // В реале: tg.sendData({ action: 'reject_user', tg_id })
            // Симуляция
            const pendingIndex = pendingUsers.findIndex(p => p.tg_id === tg_id);
            if (pendingIndex !== -1) {
                pendingUsers.splice(pendingIndex, 1);
                localStorage.setItem('pending_users', JSON.stringify(pendingUsers));
            }
            tg.showAlert('Заявка отклонена');
            loadPendingList();
        }

        function manageUsers() {
            if (userRole !== 'troupe_head') {
                tg.showAlert('Доступ только для заведующего труппой');
                return;
            }
            hideAllSections();
            document.getElementById('manage-users').classList.remove('hidden');
            loadUsersList();
            tg.BackButton.show().onClick(backToAdminPanel);
        }

        function loadUsersList() {
            const list = document.getElementById('users-list');
            list.innerHTML = '';
            // В реале: запрос к бэкенду
            // Симуляция
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.innerHTML = `
                    <strong>${p.fio}</strong> (${getRoleText(p.role)}${p.workshop ? ' (' + getDepartmentText(p.workshop) + ')' : ''})<br>
                    <select id="change-role-${p.id}">
                        <option value="${p.role}" selected>Текущая: ${getRoleText(p.role)}</option>
                        <option value="actor">Актер</option>
                        <option value="workshop_worker">Работник цеха</option>
                        <option value="workshop_head">Заведующий цехом</option>
                        <option value="troupe_head">Заведующий труппой</option>
                    </select>
                    <select id="change-workshop-${p.id}" ${!p.role.includes('workshop') ? 'class="hidden"' : ''}>
                        <option value="${p.workshop || ''}" selected>${p.workshop ? getDepartmentText(p.workshop) : 'Не назначен'}</option>
                        <option value="costume">Костюмерный</option>
                        <option value="props">Бутафорский</option>
                        <option value="lighting">Осветительный</option>
                        <option value="sound">Звуковой</option>
                        <option value="stage">Монтировочный</option>
                    </select>
                    <button onclick="changeRole(${p.id})">Изменить</button>
                    <button onclick="removeUser(${p.id})">Удалить</button>
                `;
                list.appendChild(div);

                document.getElementById(`change-role-${p.id}`).addEventListener('change', function() {
                    const wsSelect = document.getElementById(`change-workshop-${p.id}`);
                    if (this.value.includes('workshop')) wsSelect.classList.remove('hidden');
                    else wsSelect.classList.add('hidden');
                });
            });
            if (participants.length === 0) {
                list.innerHTML = '<p>Нет пользователей</p>';
            }
        }

        function changeRole(id) {
            const roleSelect = document.getElementById(`change-role-${id}`);
            const role = roleSelect.value;
            const workshopSelect = document.getElementById(`change-workshop-${id}`);
            const workshop = role.includes('workshop') ? workshopSelect.value : null;

            // В реале: tg.sendData
            // Симуляция
            const userIndex = participants.findIndex(p => p.id === id);
            if (userIndex !== -1) {
                participants[userIndex].role = role;
                participants[userIndex].workshop = workshop;
                localStorage.setItem('participants', JSON.stringify(participants));
            }

            if (id === user.id) {
                userRole = role;
                userWorkshop = workshop;
                localStorage.setItem('user_role', role);
                localStorage.setItem('user_workshop', workshop);
                updateMenuByRole();
            }

            tg.showAlert('Роль изменена');
            loadUsersList();
        }

        function removeUser(id) {
            // В реале: tg.sendData
            // Симуляция
            const userIndex = participants.findIndex(p => p.id === id);
            if (userIndex !== -1) {
                participants.splice(userIndex, 1);
                localStorage.setItem('participants', JSON.stringify(participants));
            }
            tg.showAlert('Пользователь удалён');
            loadUsersList();
        }

        function manageEvents() {
            if (userRole !== 'troupe_head') return;
            hideAllSections();
            document.getElementById('manage-events').classList.remove('hidden');
            loadManageEvents();
            tg.BackButton.show().onClick(backToAdminPanel);
        }

        function loadManageEvents() {
            const list = document.getElementById('events-manage-list');
            list.innerHTML = '';
            events.forEach(e => {
                const div = document.createElement('div');
                div.className = 'event';
                div.innerHTML = `
                    <strong>${e.title}</strong><br>
                    ${formatDate(e.datetime)}<br>
                    <div class="task-actions">
                        <button onclick="editEvent(${e.id})">Редактировать</button>
                        <button onclick="deleteEvent(${e.id})">Удалить</button>
                    </div>
                `;
                list.appendChild(div);
            });
            if (events.length === 0) {
                list.innerHTML = '<p>Событий нет</p>';
            }
        }

        function editEvent(id) {
            // Здесь можно добавить форму редактирования, для симуляции просто алерт
            tg.showAlert(`Редактирование события ${id} (реализация формы опущена в симуляции)`);
        }

        function deleteEvent(id) {
            const index = events.findIndex(e => e.id === id);
            if (index !== -1) {
                events.splice(index, 1);
                localStorage.setItem('events', JSON.stringify(events));
            }
            tg.showAlert('Событие удалено');
            loadManageEvents();
        }

        function manageTasks() {
            if (userRole !== 'troupe_head') return;
            hideAllSections();
            document.getElementById('manage-tasks').classList.remove('hidden');
            loadManageTasks();
            tg.BackButton.show().onClick(backToAdminPanel);
        }

        function loadManageTasks() {
            const list = document.getElementById('tasks-manage-list');
            list.innerHTML = '';
            tasks.forEach(t => {
                const div = document.createElement('div');
                div.className = 'task';
                div.innerHTML = `
                    <strong>${t.title}</strong> (${getDepartmentText(t.department)})<br>
                    Срок: ${t.deadline}<br>
                    <div class="task-actions">
                        <button onclick="editTask(${t.id})">Редактировать</button>
                        <button onclick="deleteTask(${t.id})">Удалить</button>
                    </div>
                `;
                list.appendChild(div);
            });
            if (tasks.length === 0) {
                list.innerHTML = '<p>Задач нет</p>';
            }
        }

        function editTask(id) {
            tg.showAlert(`Редактирование задачи ${id} (реализация формы опущена в симуляции)`);
        }

        function deleteTask(id) {
            const index = tasks.findIndex(t => t.id === id);
            if (index !== -1) {
                tasks.splice(index, 1);
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }
            tg.showAlert('Задача удалена');
            loadManageTasks();
        }

        // Вспомогательные функции
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        }

        function getStatusText(status) {
            switch (status) {
                case 'confirmed': return 'Подтверждено';
                case 'cancelled': return 'Отменено';
                default: return 'Запланировано';
            }
        }

        function getTypeText(type) {
            switch (type) {
                case 'rehearsal': return 'Репетиция';
                case 'performance': return 'Спектакль';
                case 'meeting': return 'Собрание';
                case 'other': return 'Другое';
                default: return type;
            }
        }

        function getRoleText(role) {
            switch (role) {
                case 'troupe_head': return 'Заведующий труппой';
                case 'workshop_head': return 'Заведующий цехом';
                case 'actor': return 'Актер';
                case 'workshop_worker': return 'Работник цеха';
                default: return 'Не назначено';
            }
        }

        function getDepartmentText(dept) {
            switch (dept) {
                case 'costume': return 'Костюмерный';
                case 'props': return 'Бутафорский';
                case 'lighting': return 'Осветительный';
                case 'sound': return 'Звуковой';
                case 'stage': return 'Монтировочный';
                default: return dept;
            }
        }

        function loadParticipants() {
            // Заглушка
            if (participants.length === 0) {
                participants = [
                    { id: 123456, fio: 'Админ Тестовый', role: 'troupe_head' },
                    { id: 999999, fio: 'Иванов Иван Иванович', role: 'actor' },
                    { id: 999998, fio: 'Петрова Анна Сергеевна', role: 'workshop_head', workshop: 'costume' }
                ];
                localStorage.setItem('participants', JSON.stringify(participants));
            }
        }

        // Запуск
        init();
    </script>
</body>
</html>
