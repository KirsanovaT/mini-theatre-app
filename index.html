<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Театральный планировщик</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Flatpickr для календаря -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- SheetJS для XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background 0.3s, color 0.3s;
        }
        .container { max-width: 400px; margin: 0 auto; }
        button { 
            width: 100%; padding: 12px; margin: 10px 0; 
            background: var(--tg-theme-button-color); 
            color: var(--tg-theme-button-text-color); 
            border: none; border-radius: 8px; cursor: pointer; 
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); box-sizing: border-box; }
        .event, .task { background: var(--tg-theme-secondary-bg-color); padding: 10px; margin: 10px 0; border-radius: 8px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none; }
        .step { display: none; }
        .step.active { display: block; }
        .error { color: var(--tg-theme-destructive-color); }
        .participant { display: flex; align-items: center; margin: 5px 0; }
        .participant input[type="checkbox"] { width: auto; margin-right: 10px; }
        .stats-table, .repertoire-table, .tasks-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .stats-table th, .stats-table td, .repertoire-table th, .repertoire-table td, .tasks-table th, .tasks-table td { padding: 8px; border: 1px solid var(--tg-theme-hint-color); text-align: left; font-size: 0.9em; }
        .nav-buttons { display: flex; justify-content: space-between; }
        .nav-buttons button { width: 48%; }
        .task-actions { display: flex; justify-content: space-around; margin-top: 5px; }
        .task-actions button { width: 45%; padding: 6px; font-size: 0.8em; }
        .status { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        .status.planned { background: #fff3cd; color: #856404; }
        .status.confirmed { background: #d4edda; color: #155724; }
        .status.cancelled { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Театральный планировщик</h1>
        
        <!-- Главное меню -->
        <div id="main-menu">
            <button onclick="showSchedule()">Моё расписание</button>
            <button onclick="startCreateEvent()">Создать событие</button>
            <button onclick="startWorkshopTasks()">Задачи цехам</button>
            <button onclick="showRepertoire()">Планирование репертуара</button>
            <button onclick="showStats()">Статистика</button>
        </div>
        
        <!-- Расписание -->
        <div id="schedule" class="hidden">
            <h2>Расписание</h2>
            <select id="period-select" onchange="showSchedule(this.value)">
                <option value="today">Сегодня</option>
                <option value="tomorrow">Завтра</option>
                <option value="week">Неделя</option>
            </select>
            <div id="events-list"></div>
            <button onclick="backToMenu()">Назад</button>
        </div>
        
        <!-- Репертуар на месяц -->
        <div id="repertoire" class="hidden">
            <h2>Репертуар на <span id="current-month">декабрь 2025</span></h2>
            <div class="nav-buttons">
                <button onclick="prevMonth()">Пред. месяц</button>
                <button onclick="nextMonth()">След. месяц</button>
            </div>
            <table class="repertoire-table">
                <thead><tr><th>Дата</th><th>Событие</th><th>Площадка</th><th>Тип</th></tr></thead>
                <tbody id="repertoire-table-body"></tbody>
            </table>
            <button onclick="backToMenu()">Назад</button>
        </div>
        
        <!-- Задачи цехам -->
        <div id="workshop-tasks" class="hidden">
            <h2>Задачи цехам</h2>
            <select id="filter-workshop" onchange="renderTasks()">
                <option value="">Все цеха</option>
                <option value="costume">Костюмы</option>
                <option value="decor">Декорации</option>
                <option value="light">Свет</option>
                <option value="sound">Звук</option>
            </select>
            <select id="filter-status" onchange="renderTasks()">
                <option value="">Все статусы</option>
                <option value="planned">Запланировано</option>
                <option value="confirmed">Выполнено</option>
                <option value="cancelled">Отменено</option>
            </select>
            <button onclick="startCreateTask()" id="create-task-btn" style="display: none;">Создать задачу</button>
            <div id="tasks-list"></div>
            <button onclick="backToMenu()">Назад</button>
        </div>
        
        <!-- Создание события (шаги) -->
        <div id="create-event" class="hidden">
            <h2>Создать событие</h2>
            <!-- Шаги без изменений, опущены для краткости -->
            <div id="step-type" class="step active">
                <select id="event-type">
                    <option value="performance">Спектакль</option>
                    <option value="rehearsal">Репетиция</option>
                </select>
                <button onclick="nextStep('venue')">Далее</button>
            </div>
            <div id="step-venue" class="step">
                <select id="venue-select">
                    <option value="1">Основная сцена</option>
                    <option value="2">Малая сцена</option>
                </select>
                <input type="text" id="datetime-start" placeholder="Выберите дату/время начала">
                <input type="text" id="datetime-end" placeholder="Выберите дату/время конца">
                <div id="participants-list">
                    <div class="participant"><input type="checkbox" id="part-1" checked> <label for="part-1">Вы (Артист)</label></div>
                    <div class="participant"><input type="checkbox" id="part-2"> <label for="part-2">Артист 2</label></div>
                    <div class="participant"><input type="checkbox" id="part-3"> <label for="part-3">Режиссёр</label></div>
                </div>
                <button onclick="nextStep('confirm')">Проверить конфликты</button>
                <div id="conflicts" class="error hidden"></div>
            </div>
            <div id="step-confirm" class="step">
                <p>Название: <input type="text" id="event-title" placeholder="Введите название"></p>
                <p>Участники выбраны: <span id="selected-count">0</span></p>
                <button onclick="createEvent()">Создать</button>
                <button onclick="prevStep()">Назад</button>
            </div>
        </div>
        
        <!-- Создание задачи (новый FSM) -->
        <div id="create-task" class="hidden">
            <h2>Создать задачу цеху</h2>
            <div id="task-step-1" class="step active">
                <select id="task-workshop-type">
                    <option value="costume">Костюмы</option>
                    <option value="decor">Декорации</option>
                    <option value="light">Свет</option>
                    <option value="sound">Звук</option>
                </select>
                <textarea id="task-description" placeholder="Описание задачи"></textarea>
                <input type="text" id="task-deadline" placeholder="Срок (дата/время)">
                <select id="task-linked-event">
                    <option value="">Независимая задача</option>
                    <!-- Опции событий из getEvents() -->
                </select>
                <button onclick="createTask()">Создать</button>
                <button onclick="backToTasks()">Назад</button>
            </div>
        </div>
        
        <!-- Статистика (без изменений) -->
        <div id="stats" class="hidden">
            <h2>Ваша статистика</h2>
            <select id="stats-period" onchange="showStats(this.value)">
                <option value="month">Месяц</option>
                <option value="season">Сезон</option>
            </select>
            <table class="stats-table">
                <thead><tr><th>Событие</th><th>Часы</th><th>Номер</th></tr></thead>
                <tbody id="stats-table-body"></tbody>
            </table>
            <p><strong>Итого событий: <span id="total-events">0</span> | Общих часов: <span id="total-hours">0</span></strong></p>
            <button onclick="exportStats()">Экспорт в XLSX</button>
            <button onclick="backToMenu()">Назад</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Адаптация темы
        tg.onEvent('themeChanged', () => {
            document.body.style.background = tg.themeParams.bg_color;
        });

        // User и роль (расширили для workshop_head)
        const user = tg.initDataUnsafe.user;
        const role = (user.id % 4 === 0) ? 'artist' : (user.id % 4 === 1 ? 'director' : (user.id % 4 === 2 ? 'admin' : 'workshop_head'));

        // Данные
        function getEvents() {
            return JSON.parse(localStorage.getItem('events') || '[]');
        }
        function saveEvents(events) {
            localStorage.setItem('events', JSON.stringify(events));
        }
        function getTasks() {
            return JSON.parse(localStorage.getItem('tasks') || '[]');
        }
        function saveTasks(tasks) {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        function getParticipants() {
            return [
                { id: 1, name: 'Вы (Артист)' },
                { id: 2, name: 'Артист 2' },
                { id: 3, name: 'Режиссёр' }
            ];
        }

        // Кэш репертуара (без изменений)
        let repertoireCache = { data: [], timestamp: 0 };
        function getRepertoireCache(monthStr) {
            const cached = JSON.parse(localStorage.getItem(`repertoire_${monthStr}`) || '{}');
            if (Date.now() - cached.timestamp < 3600000) {
                return cached.data;
            }
            return [];
        }
        function setRepertoireCache(monthStr, data) {
            localStorage.setItem(`repertoire_${monthStr}`, JSON.stringify({ data, timestamp: Date.now() }));
        }

        // Инициализация календаря
        flatpickr("#datetime-start", { enableTime: true, dateFormat: "Y-m-d H:i", defaultDate: new Date() });
        flatpickr("#datetime-end", { enableTime: true, dateFormat: "Y-m-d H:i", defaultDate: new Date(Date.now() + 2 * 60 * 60 * 1000) });
        flatpickr("#task-deadline", { enableTime: true, dateFormat: "Y-m-d H:i" });

        // Главное меню
        function backToMenu() {
            document.getElementById('main-menu').classList.remove('hidden');
            hideAllSteps();
            hideTaskSteps();
            document.getElementById('schedule').classList.add('hidden');
            document.getElementById('repertoire').classList.add('hidden');
            document.getElementById('workshop-tasks').classList.add('hidden');
            document.getElementById('create-event').classList.add('hidden');
            document.getElementById('create-task').classList.add('hidden');
            document.getElementById('stats').classList.add('hidden');
            tg.MainButton.hide();
        }

        // Расписание (без изменений)
        function showSchedule(period = 'today') {
            // ... (код как раньше)
        }

        // Репертуар (без изменений)
        let currentMonth = new Date();
        function showRepertoire() {
            // ... (код как раньше)
        }

        // Задачи цехам
        function startWorkshopTasks() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('workshop-tasks').classList.remove('hidden');
            document.getElementById('create-task-btn').style.display = (role === 'director' || role === 'admin') ? 'block' : 'none';
            renderTasks();
            tg.MainButton.setText('Обновить').show().onClick(renderTasks);
        }
        function renderTasks() {
            const filterWorkshop = document.getElementById('filter-workshop').value;
            const filterStatus = document.getElementById('filter-status').value;
            const tasks = getTasks().filter(t => {
                return (!filterWorkshop || t.workshop_type === filterWorkshop) &&
                       (!filterStatus || t.status === filterStatus);
            }).sort((a, b) => new Date(b.deadline) - new Date(a.deadline));
            
            const list = document.getElementById('tasks-list');
            list.innerHTML = tasks.map(t => {
                const statusClass = `status ${t.status}`;
                const linkedEvent = t.linked_event_id ? ` (привязано к событию ${t.linked_event_id})` : '';
                let actions = '';
                if (role === 'workshop_head' && t.workshop_type === 'costume') { // Симуляция: head для costume
                    actions = `
                        <div class="task-actions">
                            <button onclick="updateTaskStatus(${t.id}, 'confirmed')">Выполнено</button>
                            <button onclick="updateTaskStatus(${t.id}, 'cancelled')">Отменить</button>
                        </div>
                    `;
                }
                return `<div class="task"><strong>${t.workshop_type.toUpperCase()}${linkedEvent}</strong><br>${t.description}<br>Срок: ${new Date(t.deadline).toLocaleString()}<br><span class="${statusClass}">Статус: ${t.status}</span>${actions}</div>`;
            }).join('') || '<p>Нет задач</p>';
        }
        function updateTaskStatus(taskId, newStatus) {
            let tasks = getTasks();
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                saveTasks(tasks);
                renderTasks();
                tg.showAlert(`Статус изменён на ${newStatus}`);
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // Создание задачи
        function startCreateTask() {
            if (role !== 'director' && role !== 'admin') {
                tg.showAlert('Нет прав для создания задач');
                return;
            }
            document.getElementById('workshop-tasks').classList.add('hidden');
            document.getElementById('create-task').classList.remove('hidden');
            populateLinkedEvents();
        }
        function populateLinkedEvents() {
            const select = document.getElementById('task-linked-event');
            select.innerHTML = '<option value="">Независимая задача</option>';
            getEvents().forEach(e => {
                select.innerHTML += `<option value="${e.id}">${e.title} (${new Date(e.datetime_start).toLocaleDateString()})</option>`;
            });
        }
        function createTask() {
            const workshopType = document.getElementById('task-workshop-type').value;
            const description = document.getElementById('task-description').value;
            const deadline = document.getElementById('task-deadline').value;
            const linkedEventId = document.getElementById('task-linked-event').value;
            
            if (!description || !deadline) {
                tg.showAlert('Заполните описание и срок');
                return;
            }
            
            const newTask = {
                id: Date.now(),
                workshop_type: workshopType,
                description,
                deadline,
                linked_event_id: linkedEventId || null,
                status: 'planned'
            };
            
            let tasks = getTasks();
            tasks.push(newTask);
            saveTasks(tasks);
            
            // Симуляция уведомления главе цеха
            tg.showAlert(`Задача создана для ${workshopType}! Глава цеха уведомлён.`);
            tg.HapticFeedback.notificationOccurred('success');
            
            // Отправка боту
            tg.sendData(JSON.stringify({ action: 'create_task', task: newTask }));
            
            // Инвалидация кэшей
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('repertoire_')) localStorage.removeItem(key);
            });
            
            backToTasks();
        }
        function backToTasks() {
            document.getElementById('create-task').classList.add('hidden');
            startWorkshopTasks();
        }
        function hideTaskSteps() {
            document.querySelectorAll('#create-task .step').forEach(s => s.classList.remove('active'));
        }

        // Остальной код (создание событий, статистика и т.д.) без изменений
        function filterByPeriod(dateStr, period) {
            // ... (как раньше)
        }

        let currentStep = 'type';
        function startCreateEvent() {
            // ... (как раньше)
        }

        function showStep(step) {
            // ... (как раньше)
        }

        function nextStep(next) {
            // ... (как раньше)
        }

        function prevStep() {
            // ... (как раньше)
        }

        function hideAllSteps() {
            // ... (как раньше)
        }

        function updateSelectedCount() {
            // ... (как раньше)
        }

        function checkConflicts() {
            // ... (как раньше)
        }

        function createEvent() {
            // ... (как раньше, плюс инвалидация кэша)
            const events = getEvents();
            events.push(newEvent);
            saveEvents(events);
            // Инвалидация
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('repertoire_')) localStorage.removeItem(key);
            });
            // ...
        }

        function showStats(period = 'month') {
            // ... (как раньше)
        }

        function exportStats() {
            // ... (как раньше)
        }

        // Слушатели
        document.querySelectorAll('#participants-list input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

        tg.BackButton.show().onClick(backToMenu);
    </script>
</body>
</html>
