<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Театральный планировщик</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Flatpickr для календаря -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- SheetJS для XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background 0.3s, color 0.3s;
        }
        .container { max-width: 400px; margin: 0 auto; }
        button { 
            width: 100%; padding: 12px; margin: 10px 0; 
            background: var(--tg-theme-button-color); 
            color: var(--tg-theme-button-text-color); 
            border: none; border-radius: 8px; cursor: pointer; 
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .event { background: var(--tg-theme-secondary-bg-color); padding: 10px; margin: 10px 0; border-radius: 8px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none; }
        .step { display: none; }
        .step.active { display: block; }
        .error { color: var(--tg-theme-destructive-color); }
        .participant { display: flex; align-items: center; margin: 5px 0; }
        .participant input[type="checkbox"] { width: auto; margin-right: 10px; }
        .stats-table, .repertoire-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .stats-table th, .stats-table td, .repertoire-table th, .repertoire-table td { padding: 8px; border: 1px solid var(--tg-theme-hint-color); text-align: left; font-size: 0.9em; }
        .nav-buttons { display: flex; justify-content: space-between; }
        .nav-buttons button { width: 48%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Театральный планировщик</h1>
        
        <!-- Главное меню -->
        <div id="main-menu">
            <button onclick="showSchedule()">Моё расписание</button>
            <button onclick="startCreateEvent()">Создать событие</button>
            <button onclick="showRepertoire()">Планирование репертуара</button>
            <button onclick="showStats()">Статистика</button>
        </div>
        
        <!-- Расписание -->
        <div id="schedule" class="hidden">
            <h2>Расписание</h2>
            <select id="period-select" onchange="showSchedule(this.value)">
                <option value="today">Сегодня</option>
                <option value="tomorrow">Завтра</option>
                <option value="week">Неделя</option>
            </select>
            <div id="events-list"></div>
            <button onclick="backToMenu()">Назад</button>
        </div>
        
        <!-- Репертуар на месяц -->
        <div id="repertoire" class="hidden">
            <h2>Репертуар на <span id="current-month">декабрь 2025</span></h2>
            <div class="nav-buttons">
                <button onclick="prevMonth()">Пред. месяц</button>
                <button onclick="nextMonth()">След. месяц</button>
            </div>
            <table class="repertoire-table">
                <thead><tr><th>Дата</th><th>Событие</th><th>Площадка</th><th>Тип</th></tr></thead>
                <tbody id="repertoire-table-body"></tbody>
            </table>
            <button onclick="backToMenu()">Назад</button>
        </div>
        
        <!-- Создание события (шаги) -->
        <div id="create-event" class="hidden">
            <h2>Создать событие</h2>
            
            <!-- Шаг 1: Тип -->
            <div id="step-type" class="step active">
                <select id="event-type">
                    <option value="performance">Спектакль</option>
                    <option value="rehearsal">Репетиция</option>
                </select>
                <button onclick="nextStep('venue')">Далее</button>
            </div>
            
            <!-- Шаг 2: Дата/Время/Площадка -->
            <div id="step-venue" class="step">
                <select id="venue-select">
                    <option value="1">Основная сцена</option>
                    <option value="2">Малая сцена</option>
                </select>
                <input type="text" id="datetime-start" placeholder="Выберите дату/время начала">
                <input type="text" id="datetime-end" placeholder="Выберите дату/время конца">
                <div id="participants-list">
                    <div class="participant"><input type="checkbox" id="part-1" checked> <label for="part-1">Вы (Артист)</label></div>
                    <div class="participant"><input type="checkbox" id="part-2"> <label for="part-2">Артист 2</label></div>
                    <div class="participant"><input type="checkbox" id="part-3"> <label for="part-3">Режиссёр</label></div>
                </div>
                <button onclick="nextStep('confirm')">Проверить конфликты</button>
                <div id="conflicts" class="error hidden"></div>
            </div>
            
            <!-- Шаг 3: Подтверждение -->
            <div id="step-confirm" class="step">
                <p>Название: <input type="text" id="event-title" placeholder="Введите название"></p>
                <p>Участники выбраны: <span id="selected-count">0</span></p>
                <button onclick="createEvent()">Создать</button>
                <button onclick="prevStep()">Назад</button>
            </div>
        </div>
        
        <!-- Статистика (без баллов) -->
        <div id="stats" class="hidden">
            <h2>Ваша статистика</h2>
            <select id="stats-period" onchange="showStats(this.value)">
                <option value="month">Месяц</option>
                <option value="season">Сезон</option>
            </select>
            <table class="stats-table">
                <thead><tr><th>Событие</th><th>Часы</th><th>Номер</th></tr></thead>
                <tbody id="stats-table-body"></tbody>
            </table>
            <p><strong>Итого событий: <span id="total-events">0</span> | Общих часов: <span id="total-hours">0</span></strong></p>
            <button onclick="exportStats()">Экспорт в XLSX</button>
            <button onclick="backToMenu()">Назад</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Адаптация темы
        tg.onEvent('themeChanged', () => {
            document.body.style.background = tg.themeParams.bg_color;
        });

        // User и роль (симуляция)
        const user = tg.initDataUnsafe.user;
        const role = (user.id % 3 === 0) ? 'artist' : (user.id % 3 === 1 ? 'director' : 'admin');

        // Данные (localStorage + симуляция)
        function getEvents() {
            return JSON.parse(localStorage.getItem('events') || '[]');
        }
        function saveEvents(events) {
            localStorage.setItem('events', JSON.stringify(events));
        }
        function getParticipants() {
            return [
                { id: 1, name: 'Вы (Артист)' },
                { id: 2, name: 'Артист 2' },
                { id: 3, name: 'Режиссёр' }
            ];
        }

        // Кэш для репертуара (симуляция 1 часа)
        let repertoireCache = { data: [], timestamp: 0 };
        function getRepertoireCache(monthStr) {
            const cached = JSON.parse(localStorage.getItem(`repertoire_${monthStr}`) || '{}');
            if (Date.now() - cached.timestamp < 3600000) { // 1 час
                return cached.data;
            }
            return [];
        }
        function setRepertoireCache(monthStr, data) {
            localStorage.setItem(`repertoire_${monthStr}`, JSON.stringify({ data, timestamp: Date.now() }));
        }

        // Инициализация календаря
        flatpickr("#datetime-start", { enableTime: true, dateFormat: "Y-m-d H:i", defaultDate: new Date() });
        flatpickr("#datetime-end", { enableTime: true, dateFormat: "Y-m-d H:i", defaultDate: new Date(Date.now() + 2 * 60 * 60 * 1000) });

        // Главное меню
        function backToMenu() {
            document.getElementById('main-menu').classList.remove('hidden');
            hideAllSteps();
            document.getElementById('schedule').classList.add('hidden');
            document.getElementById('repertoire').classList.add('hidden');
            document.getElementById('create-event').classList.add('hidden');
            document.getElementById('stats').classList.add('hidden');
            tg.MainButton.hide();
        }

        // Расписание
        function showSchedule(period = 'today') {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('schedule').classList.remove('hidden');
            
            const events = getEvents().filter(e => filterByPeriod(e.datetime_start, period));
            const list = document.getElementById('events-list');
            list.innerHTML = events.map(e => 
                `<div class="event">${e.title} (${e.type})<br>${new Date(e.datetime_start).toLocaleString()} - ${new Date(e.datetime_end).toLocaleString()} на ${e.venue}</div>`
            ).join('') || '<p>Нет событий</p>';
            
            tg.MainButton.setText('Обновить').show().onClick(() => showSchedule(period));
            tg.HapticFeedback.impactOccurred('light');
        }

        // Репертуар на месяц
        let currentMonth = new Date(); // Текущий месяц
        function showRepertoire() {
            if (role !== 'director' && role !== 'admin') {
                tg.showAlert('Нет прав для просмотра репертуара');
                return;
            }
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('repertoire').classList.remove('hidden');
            renderRepertoire();
            tg.MainButton.setText('Обновить').show().onClick(renderRepertoire);
        }
        function renderRepertoire() {
            const monthStr = currentMonth.toISOString().slice(0, 7); // YYYY-MM
            let events = getRepertoireCache(monthStr);
            if (events.length === 0) {
                events = getEvents().filter(e => {
                    const date = new Date(e.datetime_start);
                    return date.getFullYear() === currentMonth.getFullYear() && date.getMonth() === currentMonth.getMonth();
                }).sort((a, b) => new Date(a.datetime_start) - new Date(b.datetime_start));
                setRepertoireCache(monthStr, events);
            }
            
            document.getElementById('current-month').textContent = currentMonth.toLocaleDateString('ru', { month: 'long', year: 'numeric' });
            
            const tableBody = document.getElementById('repertoire-table-body');
            tableBody.innerHTML = events.map(e => {
                const date = new Date(e.datetime_start).toLocaleDateString('ru', { day: 'numeric', weekday: 'short' });
                return `<tr><td>${date}</td><td>${e.title}</td><td>${e.venue}</td><td>${e.type}</td></tr>`;
            }).join('') || '<tr><td colspan="4">Нет событий</td></tr>';
            
            tg.HapticFeedback.impactOccurred('light');
        }
        function prevMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderRepertoire();
            tg.HapticFeedback.selectionChanged();
        }
        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderRepertoire();
            tg.HapticFeedback.selectionChanged();
        }

        function filterByPeriod(dateStr, period) {
            const date = new Date(dateStr);
            const now = new Date();
            switch (period) {
                case 'today': return date.toDateString() === now.toDateString();
                case 'tomorrow': return date.toDateString() === new Date(now.getTime() + 86400000).toDateString();
                case 'week': return date >= now && date <= new Date(now.getTime() + 7 * 86400000);
                case 'month': return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                case 'season': return date >= new Date(now.getFullYear(), 0, 1) && date <= new Date(now.getFullYear(), 11, 31);
                default: return true;
            }
        }

        // Создание события (FSM) — без изменений
        let currentStep = 'type';
        function startCreateEvent() {
            if (role !== 'director' && role !== 'admin') {
                tg.showAlert('Нет прав для создания событий');
                return;
            }
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('create-event').classList.remove('hidden');
            showStep('type');
            tg.MainButton.setText('Отмена').show().onClick(backToMenu);
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            currentStep = step;
            if (step === 'venue') updateSelectedCount();
        }

        function nextStep(next) {
            if (next === 'confirm') {
                checkConflicts();
                return;
            }
            showStep(next);
            tg.HapticFeedback.selectionChanged();
        }

        function prevStep() {
            const steps = ['type', 'venue', 'confirm'];
            const idx = steps.indexOf(currentStep);
            if (idx > 0) showStep(steps[idx - 1]);
        }

        function hideAllSteps() {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('#participants-list input:checked').length;
            document.getElementById('selected-count').textContent = count;
        }

        function checkConflicts() {
            const start = document.getElementById('datetime-start').value;
            const end = document.getElementById('datetime-end').value;
            const venueId = document.getElementById('venue-select').value;
            const selectedParts = Array.from(document.querySelectorAll('#participants-list input:checked')).map(cb => parseInt(cb.id.split('-')[1]));
            const events = getEvents();
            
            const conflicts = events.filter(e => {
                const eStart = new Date(e.datetime_start);
                const eEnd = new Date(e.datetime_end);
                const overlap = !(new Date(end) <= eStart || new Date(start) >= eEnd);
                return e.venue_id === parseInt(venueId) && overlap && e.status !== 'cancelled' &&
                       selectedParts.some(p => e.participants.includes(p));
            });
            
            const conflictsDiv = document.getElementById('conflicts');
            if (conflicts.length > 0) {
                conflictsDiv.innerHTML = `Конфликты: ${conflicts.map(e => e.title).join(', ')}`;
                conflictsDiv.classList.remove('hidden');
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            conflictsDiv.classList.add('hidden');
            showStep('confirm');
            tg.HapticFeedback.notificationOccurred('success');
        }

        function createEvent() {
            const type = document.getElementById('event-type').value;
            const title = document.getElementById('event-title').value || 'Новое событие';
            const venueId = document.getElementById('venue-select').value;
            const venue = venueId === '1' ? 'Основная сцена' : 'Малая сцена';
            const start = document.getElementById('datetime-start').value;
            const end = document.getElementById('datetime-end').value;
            const participants = Array.from(document.querySelectorAll('#participants-list input:checked')).map(cb => parseInt(cb.id.split('-')[1]));
            
            if (!start || !end || new Date(start) >= new Date(end) || participants.length === 0) {
                tg.showAlert('Проверьте данные');
                return;
            }
            
            const newEvent = {
                id: Date.now(),
                type, title, venue_id: parseInt(venueId), venue,
                datetime_start: start, datetime_end: end,
                status: 'planned',
                participants
            };
            
            const events = getEvents();
            events.push(newEvent);
            saveEvents(events);
            
            // Инвалидация кэша репертуара
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('repertoire_')) localStorage.removeItem(key);
            });
            
            tg.showAlert('Событие создано!');
            tg.HapticFeedback.notificationOccurred('success');
            tg.sendData(JSON.stringify({ action: 'create_event', event: newEvent }));
            backToMenu();
        }

        // Статистика (без изменений)
        function showStats(period = 'month') {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('stats').classList.remove('hidden');
            
            const events = getEvents().filter(e => filterByPeriod(e.datetime_start, period));
            let totalHours = 0;
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            
            events.forEach((e, idx) => {
                const durationHours = (new Date(e.datetime_end) - new Date(e.datetime_start)) / (1000 * 60 * 60);
                totalHours += durationHours;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${e.title} (${e.type})</td>
                    <td>${durationHours.toFixed(1)}</td>
                    <td>${idx + 1}</td>
                `;
                tableBody.appendChild(row);
            });
            
            document.getElementById('total-events').textContent = events.length;
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            tg.MainButton.setText('Обновить').show().onClick(() => showStats(period));
        }

        function exportStats() {
            const wb = XLSX.utils.book_new();
            const wsData = [['Событие', 'Часы', 'Номер']];
            const events = getEvents();
            let totalHours = 0;
            events.forEach((e, idx) => {
                const durationHours = (new Date(e.datetime_end) - new Date(e.datetime_start)) / (1000 * 60 * 60);
                totalHours += durationHours;
                wsData.push([e.title, durationHours.toFixed(1), idx + 1]);
            });
            wsData.push(['', '', '']);
            wsData.push(['Итого событий', events.length, '']);
            wsData.push(['Общих часов', totalHours.toFixed(1), '']);
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Статистика');
            XLSX.writeFile(wb, 'theatre_stats.xlsx');
            tg.HapticFeedback.notificationOccurred('success');
        }

        // Слушатели
        document.querySelectorAll('#participants-list input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

        tg.BackButton.show().onClick(backToMenu);
    </script>
</body>
</html>
