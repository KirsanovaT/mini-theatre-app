<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Театральный планировщик</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background 0.3s, color 0.3s;
        }
        .container { max-width: 400px; margin: 0 auto; }
        button { 
            width: 100%; padding: 12px; margin: 10px 0; 
            background: var(--tg-theme-button-color); 
            color: var(--tg-theme-button-text-color); 
            border: none; border-radius: 8px; cursor: pointer; 
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .event { background: var(--tg-theme-secondary-bg-color); padding: 10px; margin: 10px 0; border-radius: 8px; }
        .hidden { display: none; }
        .step { display: none; }
        .step.active { display: block; }
        .error { color: var(--tg-theme-destructive-color); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Театральный планировщик</h1>
        
        <!-- Главное меню -->
        <div id="main-menu">
            <button onclick="showSchedule()">Моё расписание</button>
            <button onclick="startCreateEvent()">Создать событие</button>
            <button onclick="showStats()">Статистика</button> <!-- Упрощённо -->
        </div>
        
        <!-- Расписание -->
        <div id="schedule" class="hidden">
            <h2>Расписание на сегодня</h2>
            <div id="events-list"></div>
            <button onclick="backToMenu()">Назад</button>
        </div>
        
        <!-- Создание события (шаги FSM-like) -->
        <div id="create-event" class="hidden">
            <h2>Создать событие</h2>
            
            <!-- Шаг 1: Тип -->
            <div id="step-type" class="step active">
                <select id="event-type">
                    <option value="performance">Спектакль</option>
                    <option value="rehearsal">Репетиция</option>
                </select>
                <button onclick="nextStep('venue')">Далее</button>
            </div>
            
            <!-- Шаг 2: Дата/Время -->
            <div id="step-venue" class="step">
                <select id="venue-select">
                    <option value="1">Основная сцена</option>
                    <option value="2">Малая сцена</option>
                </select>
                <input type="datetime-local" id="datetime-start">
                <input type="datetime-local" id="datetime-end">
                <button onclick="nextStep('confirm')">Проверить конфликты</button>
                <div id="conflicts" class="error hidden"></div>
            </div>
            
            <!-- Шаг 3: Подтверждение -->
            <div id="step-confirm" class="step">
                <p>Участники: Вы (артист)</p>
                <button onclick="createEvent()">Создать</button>
                <button onclick="prevStep()">Назад</button>
            </div>
        </div>
        
        <!-- Статистика (упрощённо) -->
        <div id="stats" class="hidden">
            <h2>Ваша статистика</h2>
            <p>Баллы: 150 | Спектаклей: 5 | Часов: 20</p>
            <button onclick="backToMenu()">Назад</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Адаптация темы
        tg.onEvent('themeChanged', () => {
            document.body.style.background = tg.themeParams.bg_color;
            // Другие цвета...
        });

        // Инициализация: Получить user из initData
        const user = tg.initDataUnsafe.user;
        if (!user) {
            alert('Ошибка авторизации');
            tg.close();
        }
        console.log('User:', user); // Роль: симулируем по user.id % 3 (0=artist)

        // Симуляция данных (localStorage)
        function getEvents() {
            return JSON.parse(localStorage.getItem('events') || '[]');
        }
        function saveEvents(events) {
            localStorage.setItem('events', JSON.stringify(events));
        }

        // Главное меню
        function backToMenu() {
            document.getElementById('main-menu').classList.remove('hidden');
            hideAllSteps();
            document.getElementById('schedule').classList.add('hidden');
            document.getElementById('create-event').classList.add('hidden');
            document.getElementById('stats').classList.add('hidden');
            tg.MainButton.hide();
        }

        // Расписание
        function showSchedule(period = 'today') {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('schedule').classList.remove('hidden');
            
            const events = getEvents().filter(e => {
                const now = new Date();
                const start = new Date(e.datetime_start);
                if (period === 'today') return start.toDateString() === now.toDateString();
                return true; // Упрощённо
            });
            
            const list = document.getElementById('events-list');
            list.innerHTML = events.map(e => 
                `<div class="event">${e.title} (${e.type})<br>${new Date(e.datetime_start).toLocaleString()} - ${new Date(e.datetime_end).toLocaleString()} на ${e.venue}</div>`
            ).join('') || '<p>Нет событий</p>';
            
            tg.MainButton.setText('Обновить').show().onClick(() => showSchedule());
            tg.HapticFeedback.impactOccurred('light');
        }

        // Создание события
        let currentStep = 'type';
        function startCreateEvent() {
            // Проверка роли (упрощённо)
            if (user.id % 3 !== 0) { // Симулируем artist=0
                alert('Нет прав для создания событий');
                return;
            }
            
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('create-event').classList.remove('hidden');
            showStep('type');
            tg.MainButton.setText('Отмена').show().onClick(backToMenu);
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            currentStep = step;
        }

        function nextStep(next) {
            if (next === 'confirm') {
                checkConflicts();
                return;
            }
            showStep(next);
            tg.HapticFeedback.selectionChanged();
        }

        function prevStep() {
            const steps = ['type', 'venue', 'confirm'];
            const idx = steps.indexOf(currentStep);
            if (idx > 0) showStep(steps[idx - 1]);
        }

        function hideAllSteps() {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        }

        // Проверка конфликтов (JS-аналог SQL JOIN)
        function checkConflicts() {
            const start = new Date(document.getElementById('datetime-start').value);
            const end = new Date(document.getElementById('datetime-end').value);
            const venueId = document.getElementById('venue-select').value;
            const events = getEvents();
            
            const conflicts = events.filter(e => {
                const eStart = new Date(e.datetime_start);
                const eEnd = new Date(e.datetime_end);
                return e.venue_id === parseInt(venueId) && // Площадка
                       !(end <= eStart || start >= eEnd) && // Overlap
                       e.status !== 'cancelled';
            });
            
            const conflictsDiv = document.getElementById('conflicts');
            if (conflicts.length > 0) {
                conflictsDiv.innerHTML = `Конфликты: ${conflicts.map(e => e.title).join(', ')}`;
                conflictsDiv.classList.remove('hidden');
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            conflictsDiv.classList.add('hidden');
            showStep('confirm');
            tg.HapticFeedback.notificationOccurred('success');
        }

        // Создать событие
        function createEvent() {
            const type = document.getElementById('event-type').value;
            const title = prompt('Название события:') || 'Новое событие';
            const venueId = document.getElementById('venue-select').value;
            const venue = venueId === '1' ? 'Основная сцена' : 'Малая сцена';
            const start = document.getElementById('datetime-start').value;
            const end = document.getElementById('datetime-end').value;
            
            if (!start || !end || start >= end) {
                alert('Неверные даты');
                return;
            }
            
            const newEvent = {
                id: Date.now(),
                type, title, venue_id: parseInt(venueId), venue,
                datetime_start: start, datetime_end: end,
                status: 'planned',
                participants: [user.id] // Упрощённо
            };
            
            const events = getEvents();
            events.push(newEvent);
            saveEvents(events);
            
            tg.showAlert('Событие создано!');
            tg.HapticFeedback.notificationOccurred('success');
            
            // Отправка данных боту (JSON строка)
            tg.sendData(JSON.stringify({ action: 'create_event', event: newEvent }));
            
            backToMenu();
        }

        // Статистика (симуляция)
        function showStats() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('stats').classList.remove('hidden');
            tg.MainButton.hide();
        }

        // Кнопка назад
        tg.BackButton.show().onClick(backToMenu);
    </script>
</body>
</html>